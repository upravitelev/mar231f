# Метрики вовлечения pt2 {-}

## Запись занятия

<iframe width="560" height="315" src="https://www.youtube.com/embed/Cd-N3hVf_vw?si=fKqYCufqwEPWtW5E" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Код занятия на Python
https://colab.research.google.com/drive/1FcFTz7sI8QXhVLcLnshyHFMdGS5znlw5?usp=sharing


## Разбор домашнего задания

### level 2 (HNTR) {-}

Необходимо подсчитать и нарисовать, сколько пользователей в день приходит в приложение, в том числе и с разбивкой по платформам. Датасет: <https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv>

Решение:

``` r
# подключаем пакеты (они до этого должны быть установлены)
library(data.table)
library(plotly)

# если есть ошибка с %>%, то явно подключаем соответствующий пакет
library(magrittr)

# импортируем данные
# installs <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv')
installs <- fread('./data/installs.csv')

# считаем количество уникальных пользователей по дням
intalls_stat <- installs[, list(n_users = uniqueN(user_pseudo_id)), 
                         by = list(dt, media_source)]

# сортируем по дате инсталла
intalls_stat <- intalls_stat[order(dt)]

# рисуем график
plot_ly(intalls_stat, x = ~dt, y = ~n_users, color = ~media_source,
        type = 'scatter', mode = 'none', stackgroup = 'one') %>%
  layout(
    title = 'Установки приложения по дням',
    xaxis = list(title = ''),
    yaxis = list(title = '', rangemode = 'tozero')) %>%  
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-a01113da2c7afc32058c" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-a01113da2c7afc32058c">{"x":{"visdat":{"8c7e645e0cd8":["function () ","plotlyVisDat"]},"cur_data":"8c7e645e0cd8","attrs":{"8c7e645e0cd8":{"x":{},"y":{},"mode":"none","stackgroup":"one","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Установки приложения по дням","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[1498,1316,1206,1361,1570,1438,1191,1396,1269,1174,1258,1571,1401,1344,1367,1397,1285,1391,1592,1526,1258,968,981,870,864,859,845,714,694,584,545,606,607,599,491,484,503,528,551,591,563,493,437,474,401,433,410,410,434,360,388,431,419,442,386,401,375,444,492,469,440],"mode":"none","stackgroup":"one","type":"scatter","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23"],"y":[29,62,83,92,88,73,71,67,68,44,54,56,58,44,59,56,56,68,90,72,4,2,1],"mode":"none","stackgroup":"one","type":"scatter","name":"Facebook Ads","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[1035,1067,1034,1447,1764,1461,1249,1509,1312,1315,1495,1600,1405,1269,1321,1301,1642,2528,3064,2908,2045,1038,1013,688,98,49,31,17,14,10,5,3,9,3,3,6,5,8,4,4,4,6,5,4,10,4,1,1,4,5,3,6,6,4,7,3,1,1,4],"mode":"none","stackgroup":"one","type":"scatter","name":"applovin_int","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03"],"y":[147,145,142,223,238,245,238,236,261,214,304,329,280,211,364,394,311,334,266,293,316,392,428,393,366,434,224,24,8,7,4,2,1],"mode":"none","stackgroup":"one","type":"scatter","name":"googleadwords_int","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-04","2022-06-05","2022-06-06","2022-06-08","2022-06-09","2022-06-10","2022-06-12","2022-06-13","2022-06-16","2022-06-17","2022-06-18","2022-06-21","2022-06-22","2022-06-24","2022-06-25"],"y":[1,4,2,2,1,1,4,4,2,1,2,2,1,1,2,2],"mode":"none","stackgroup":"one","type":"scatter","name":"organic","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-24","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30"],"y":[150,275,273,357,308,289,293,321,294,276,314,286,298,289,338,384,301,319,286,247,116,93,87,76,115,128,151,83,82,51,6,5,7,7,4,2,4,2,3,2,1,2,2,2,1,1,3,1,1,1,2,2,3,1,2,1,3],"mode":"none","stackgroup":"one","type":"scatter","name":"other","marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"line":{"color":"rgba(255,217,47,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-31"],"y":[1519,1075,727,913,987,879,810,842,772,549,806,720,700,553,444,613,766,914,962,801,838,405,331,414,667,785,844,676,549,75,21,12,11,3,2,2,1,1,2,3,1,1,2,4,2,6,1,3,1,2,2,2,1,5,1,2,1],"mode":"none","stackgroup":"one","type":"scatter","name":"unityads_int","marker":{"color":"rgba(229,196,148,1)","line":{"color":"rgba(229,196,148,1)"}},"textfont":{"color":"rgba(229,196,148,1)"},"error_y":{"color":"rgba(229,196,148,1)"},"error_x":{"color":"rgba(229,196,148,1)"},"line":{"color":"rgba(229,196,148,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 4 (UV) {-}
На основе данных по [логинам](https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv) нарисуйте [area plot](https://en.wikipedia.org/wiki/Area_chart) DAU проекта, в котором цветами выделите группы пользователей по количеству дней с момента инсталла:

-   группа 1: 0 дней с инсталла

-   группа 2: 1-7 дней с момента инсталла

-   группа 3: 8-28 дней с инсталла

-   группа 4: более 28 дней с инсталла

У вас должно получится что-то вроде слоеного пирога, где цветами выделены группы. Подумайте, есть ли необходимость рисовать этот график не в абсолютных числах (количество пользователей), а в долях каждой группы от DAU, в чем могут быть плюсы и минусы такого графика. Возможно, вам потребуется нарисовать графики разных типов, чтобы ответить на этот вопрос.

Попробуйте подумать, что говорит подобный график о продукте и его пользователях. Есть ли у него проблемные зоны, над которыми надо поработать или которые могут влиять на стратегию развития и/или оперирования продукта?


Решение:

``` r
# если падает по таймауту
options(timeout=360)

# импортируем датасает
# dau <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv')
dau <- fread('./data/logins.csv')

# считаем количество дней от инсталла
dau[, lifetime := login_dt - install_dt]

# делим на группы
dau[, lifetime_group := cut(lifetime, 
                            breaks = c(-Inf, -1, 0, 7, 28, Inf), 
                            ordered_result = TRUE)]

# если хотим перезадать порядок уровней
# dau[, lifetime_group_ := factor(lifetime_group, 
#                                levels = c('(-1,0]', 
#                                           '(28, Inf]', '(0,7]', 
#                                           '(7,28]', '(-Inf,-1]'))]


# второй способ разметить группы
# dau[lifetime == 0, lifetime_group_3 := '0. 0 day']
# dau[lifetime >= 1 & lifetime <= 7, lifetime_group_3 := '1. 1-7 days']
# dau[lifetime >= 8 & lifetime <= 28, lifetime_group_3 := '2. 8-28 days']
# dau[lifetime >= 28 & lifetime <= 90, lifetime_group_3 := '3. 28+ days']

# создаем отдельную группу для тех, про кого мы не знаем
# dau[is.na(lifetime_group), lifetime_group_3 := 'unknown']

# третий метод, с помощью fcase
# dau[, lifetime_group := fcase(
#   lifetime == 0, '0 дней',
#   lifetime >= 1 & lifetime <= 7, '1-7 дней'
# )]

# считаем DAU
dau_stat <- dau[, list(n_users = uniqueN(user_pseudo_id)),
                keyby = list(login_dt, lifetime_group)]

dau_stat[, total_users := sum(n_users), by = login_dt]
dau_stat[, share := n_users / total_users]


# area-plot
plot_ly(dau_stat, x = ~login_dt, y = ~n_users, color = ~lifetime_group,
        type = 'scatter', mode = 'none', stackgroup = 'one') %>%
  layout(
    title = 'DAU по группам пользователей',
    xaxis = list(title = ''),
    yaxis = list(title = '', rangemode = 'tozero')) %>%  
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-d97bf30f8204e63947a7" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-d97bf30f8204e63947a7">{"x":{"visdat":{"8c7e4b45590f":["function () ","plotlyVisDat"]},"cur_data":"8c7e4b45590f","attrs":{"8c7e4b45590f":{"x":{},"y":{},"mode":"none","stackgroup":"one","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"DAU по группам пользователей","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[22421,22193,21794,21304,21817,22079,21940,21881,20991,20803,19985,20502,20912,20892,20663,20668,20217,19820,20137,20579,20445,20475,20123,19907,19232,19823,19938,19882,19824,19509,19026,18709,19490,19505,19623,19725,19565,19489,18783,19204,19513,19523,19341,19339,18740,18489,19097,19406,19572,19541,19477,19055,18741,19150,19302,19121,18872,18676,18409,17629,17872],"mode":"none","stackgroup":"one","type":"scatter","name":"(28, Inf]","marker":{"color":"rgba(253,231,37,1)","line":{"color":"rgba(253,231,37,1)"}},"textfont":{"color":"rgba(253,231,37,1)"},"error_y":{"color":"rgba(253,231,37,1)"},"error_x":{"color":"rgba(253,231,37,1)"},"line":{"color":"rgba(253,231,37,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[7401,7256,7094,7015,7369,7558,7680,8061,7797,7593,7142,7379,7462,7377,7125,7042,6916,6728,6884,7078,7029,6901,6717,6657,6478,6711,6922,7067,7006,6768,6437,6173,6223,5831,5480,5152,4879,4638,4151,3940,3778,3499,3321,3126,2759,2595,2446,2201,1960,1753,1662,1533,1417,1317,1297,1266,1197,1158,1156,1125,1179],"mode":"none","stackgroup":"one","type":"scatter","name":"(7,28]","marker":{"color":"rgba(93,200,99,1)","line":{"color":"rgba(93,200,99,1)"}},"textfont":{"color":"rgba(93,200,99,1)"},"error_y":{"color":"rgba(93,200,99,1)"},"error_x":{"color":"rgba(93,200,99,1)"},"line":{"color":"rgba(93,200,99,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[6317,6192,6084,5873,6182,6414,6422,6437,6292,6047,5897,5960,5957,6020,5758,5681,5470,5589,5941,6302,6601,6496,5975,5401,4880,4358,3770,3233,2735,2300,1870,1560,1353,1176,1013,919,859,821,807,845,857,838,810,759,787,725,710,669,683,673,640,663,634,661,677,677,647,644,621,623,665],"mode":"none","stackgroup":"one","type":"scatter","name":"(0,7]","marker":{"color":"rgba(33,144,140,1)","line":{"color":"rgba(33,144,140,1)"}},"textfont":{"color":"rgba(33,144,140,1)"},"error_y":{"color":"rgba(33,144,140,1)"},"error_x":{"color":"rgba(33,144,140,1)"},"line":{"color":"rgba(33,144,140,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[4380,3937,3470,4386,4947,4381,3847,4374,3972,3577,4220,4564,4140,3705,3892,4154,4369,5550,6250,5844,4580,2917,2839,2452,5,2245,2094,1518,1350,726,577,621,625,621,509,6,518,536,553,588,570,506,451,487,426,436,413,428,444,1,396,447,418,444,398,405,388,449,491,470,442],"mode":"none","stackgroup":"one","type":"scatter","name":"(-1,0]","marker":{"color":"rgba(59,82,139,1)","line":{"color":"rgba(59,82,139,1)"}},"textfont":{"color":"rgba(59,82,139,1)"},"error_y":{"color":"rgba(59,82,139,1)"},"error_x":{"color":"rgba(59,82,139,1)"},"line":{"color":"rgba(59,82,139,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[388,349,375,357,345,375,370,386,397,385,366,385,393,381,374,375,374,364,369,358,365,351,344,342,316,318,309,314,306,301,289,275,295,291,275,266,261,261,245,241,250,247,234,243,225,214,211,208,214,208,203,190,186,192,199,199,184,175,183,176,186],"mode":"none","stackgroup":"one","type":"scatter","name":"(-Inf,-1]","marker":{"color":"rgba(68,1,84,1)","line":{"color":"rgba(68,1,84,1)"}},"textfont":{"color":"rgba(68,1,84,1)"},"error_y":{"color":"rgba(68,1,84,1)"},"error_x":{"color":"rgba(68,1,84,1)"},"line":{"color":"rgba(68,1,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

``` r
# график линиями
plot_ly(dau_stat, x = ~login_dt, y = ~n_users, color = ~lifetime_group,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'DAU по группам пользователей',
    xaxis = list(title = ''),
    yaxis = list(title = '', rangemode = 'tozero')) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-13a4e26bd00da9fd30b6" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-13a4e26bd00da9fd30b6">{"x":{"visdat":{"8c7e3a566f36":["function () ","plotlyVisDat"]},"cur_data":"8c7e3a566f36","attrs":{"8c7e3a566f36":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"DAU по группам пользователей","xaxis":{"domain":[0,1],"automargin":true,"title":""},"yaxis":{"domain":[0,1],"automargin":true,"title":"","rangemode":"tozero"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[22421,22193,21794,21304,21817,22079,21940,21881,20991,20803,19985,20502,20912,20892,20663,20668,20217,19820,20137,20579,20445,20475,20123,19907,19232,19823,19938,19882,19824,19509,19026,18709,19490,19505,19623,19725,19565,19489,18783,19204,19513,19523,19341,19339,18740,18489,19097,19406,19572,19541,19477,19055,18741,19150,19302,19121,18872,18676,18409,17629,17872],"mode":"lines","type":"scatter","name":"(28, Inf]","marker":{"color":"rgba(253,231,37,1)","line":{"color":"rgba(253,231,37,1)"}},"textfont":{"color":"rgba(253,231,37,1)"},"error_y":{"color":"rgba(253,231,37,1)"},"error_x":{"color":"rgba(253,231,37,1)"},"line":{"color":"rgba(253,231,37,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[7401,7256,7094,7015,7369,7558,7680,8061,7797,7593,7142,7379,7462,7377,7125,7042,6916,6728,6884,7078,7029,6901,6717,6657,6478,6711,6922,7067,7006,6768,6437,6173,6223,5831,5480,5152,4879,4638,4151,3940,3778,3499,3321,3126,2759,2595,2446,2201,1960,1753,1662,1533,1417,1317,1297,1266,1197,1158,1156,1125,1179],"mode":"lines","type":"scatter","name":"(7,28]","marker":{"color":"rgba(93,200,99,1)","line":{"color":"rgba(93,200,99,1)"}},"textfont":{"color":"rgba(93,200,99,1)"},"error_y":{"color":"rgba(93,200,99,1)"},"error_x":{"color":"rgba(93,200,99,1)"},"line":{"color":"rgba(93,200,99,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[6317,6192,6084,5873,6182,6414,6422,6437,6292,6047,5897,5960,5957,6020,5758,5681,5470,5589,5941,6302,6601,6496,5975,5401,4880,4358,3770,3233,2735,2300,1870,1560,1353,1176,1013,919,859,821,807,845,857,838,810,759,787,725,710,669,683,673,640,663,634,661,677,677,647,644,621,623,665],"mode":"lines","type":"scatter","name":"(0,7]","marker":{"color":"rgba(33,144,140,1)","line":{"color":"rgba(33,144,140,1)"}},"textfont":{"color":"rgba(33,144,140,1)"},"error_y":{"color":"rgba(33,144,140,1)"},"error_x":{"color":"rgba(33,144,140,1)"},"line":{"color":"rgba(33,144,140,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[4380,3937,3470,4386,4947,4381,3847,4374,3972,3577,4220,4564,4140,3705,3892,4154,4369,5550,6250,5844,4580,2917,2839,2452,5,2245,2094,1518,1350,726,577,621,625,621,509,6,518,536,553,588,570,506,451,487,426,436,413,428,444,1,396,447,418,444,398,405,388,449,491,470,442],"mode":"lines","type":"scatter","name":"(-1,0]","marker":{"color":"rgba(59,82,139,1)","line":{"color":"rgba(59,82,139,1)"}},"textfont":{"color":"rgba(59,82,139,1)"},"error_y":{"color":"rgba(59,82,139,1)"},"error_x":{"color":"rgba(59,82,139,1)"},"line":{"color":"rgba(59,82,139,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[388,349,375,357,345,375,370,386,397,385,366,385,393,381,374,375,374,364,369,358,365,351,344,342,316,318,309,314,306,301,289,275,295,291,275,266,261,261,245,241,250,247,234,243,225,214,211,208,214,208,203,190,186,192,199,199,184,175,183,176,186],"mode":"lines","type":"scatter","name":"(-Inf,-1]","marker":{"color":"rgba(68,1,84,1)","line":{"color":"rgba(68,1,84,1)"}},"textfont":{"color":"rgba(68,1,84,1)"},"error_y":{"color":"rgba(68,1,84,1)"},"error_x":{"color":"rgba(68,1,84,1)"},"line":{"color":"rgba(68,1,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 5 (N) {-}

Постройте графики DAU, MAU и их отношения для данных за июль. Проинтерпретируйте метрику DAU/MAU, что она говорит о проекте?

Решение. Строим график MAU.

``` r
# берем интересующие нас дни
dates <- dau[login_dt >= '2022-07-01', sort(unique(login_dt))]

# проходим циклом lapply
mau_stat <- lapply(dates[1:2], function(x) {
  # берем данные в интервале "наша дата - 30 дней -- наша дата"
  result <- dau[login_dt >= x - 30 & login_dt <= x]
  # считаем, сколько пользователей заходило за это время (mau)
  result <- result[, list(dt = x, dt_lb = x - 30, mau = uniqueN(user_pseudo_id))]
  result
})
# собираем все в табличку
mau_stat <- rbindlist(mau_stat)

# аналогичное решение, более современное по функциям
# + считаем одновременно dau и mau
library(purrr)
mau_stat <- map_df(dates, function(x) {
  result <- dau[, list(
    dt = x,
    dt_lb = x - 30, 
    metric_dau = uniqueN(user_pseudo_id[login_dt == x]),
    metric_mau = uniqueN(user_pseudo_id[login_dt >= x - 30 & login_dt <= x])
  )]
  result
})

setDT(mau_stat)

# считаем stickiness
mau_stat[, stickiness := metric_dau / metric_mau]

# рисуем DAU и MAU
plot_ly(mau_stat, x = ~dt, y = ~metric_mau, 
        type = 'scatter', mode = 'lines', name = 'MAU') %>%
  add_trace(y = ~metric_dau, name = 'DAU') %>%
  layout(
    title = 'DAU и MAU',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-ef81f6b9d754607599a6" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-ef81f6b9d754607599a6">{"x":{"visdat":{"8c7e15d6ad60":["function () ","plotlyVisDat"]},"cur_data":"8c7e15d6ad60","attrs":{"8c7e15d6ad60":{"x":{},"y":{},"mode":"lines","name":"MAU","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"8c7e15d6ad60.1":{"x":{},"y":{},"mode":"lines","name":"DAU","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"DAU и MAU","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"metric_mau"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[189861,185509,181612,178135,173937,168735,164463,160057,154916,150581,146788,142618,138092,134044,130122,126334,122214,118223,113486,107645,102562,98154,94817,91697,88858,87345,84566,81990,79918,77996,76651],"mode":"lines","name":"MAU","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[27804,26954,27579,27028,26516,25689,25711,25375,24180,24469,24599,24244,23804,23588,22589,22121,22541,22576,22525,21848,22045,21581,21087,21450,21546,21346,20983,20805,20561,19731,20049],"mode":"lines","name":"DAU","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

``` r
# рисуем stickiness
plot_ly(mau_stat, x = ~dt, y = ~stickiness, type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'DAU / MAU',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-58bf5a49fb698181cc94" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-58bf5a49fb698181cc94">{"x":{"visdat":{"8c7e7354fcd1":["function () ","plotlyVisDat"]},"cur_data":"8c7e7354fcd1","attrs":{"8c7e7354fcd1":{"x":{},"y":{},"mode":"lines","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"DAU / MAU","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"stickiness"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":false},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.14644397743612433,0.14529753273426088,0.15185670550404159,0.151727622308923,0.15244600056342239,0.15224464396835274,0.15633303539397919,0.15853727109717164,0.1560845877766015,0.16249726061056841,0.16758181867727606,0.16999256755809225,0.17237783506647741,0.17597206887290739,0.17359862283088179,0.17509933984517231,0.18443877133552622,0.19096114969168435,0.19848263221895213,0.20296344465604532,0.21494315633470487,0.21986877763514479,0.22239682757311452,0.23392259288744452,0.24247676067433432,0.24438720018318164,0.24812572428635621,0.25375045737285035,0.25727620811331614,0.25297451151341094,0.26156214530795424],"mode":"lines","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


## Расчет retention

Общая логика расчета:
- считаем lifetime
- считаем количество пользователей на каждый день от инсталла 
- считаем долю этих пользователей от всего пользователей когорты
- ограничиваем на общий доступный лайфтайм
- рисуем график
- опционально -- добавляем группировку



``` r
# берем только тех, кто пришел в июне
retention <- dau[install_dt >= '2022-06-01']
retention <- retention[install_dt < '2022-07-01']

# ограничиваем на минимальное общее количество дней
retention <- retention[lifetime <= 30 & lifetime >= 0]

# считаем количество вернувшихся
retention_stat <- retention[, list(returned = uniqueN(user_pseudo_id)),
                            keyby = list(platform, lifetime)]

# считаем,с колько всего было
retention_stat[, total_users := returned[lifetime == 0], by = platform]

# второй вариант расчета total_users, через merge
retention_stat <- merge(
  retention_stat,
  retention_stat[lifetime == 0, list(platform, total_users_2 = returned)],
  by = 'platform', all.x = TRUE
)

# считаем retention
retention_stat[, ret := returned / total_users]


# рисуем график
plot_ly(retention_stat, x = ~lifetime, y = ~ret, color = ~platform,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Retention rate',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-b7a7c162b418ec4ea16c" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-b7a7c162b418ec4ea16c">{"x":{"visdat":{"8c7e3c542978":["function () ","plotlyVisDat"]},"cur_data":"8c7e3c542978","attrs":{"8c7e3c542978":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Retention rate","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.31723323270770443,0.21563197269982937,0.17053419083869273,0.144192151200945,0.12793017456359101,0.11725948287176795,0.10749442184013649,0.097178107363171021,0.090536815855099095,0.084000525003281271,0.077031106444415284,0.072699829373933586,0.069405433783961148,0.066819792623703897,0.062094763092269328,0.059325370783567401,0.05631972699829374,0.053865336658354114,0.051371571072319204,0.050584066150413443,0.048969681060506629,0.046882793017456362,0.044441527759548495,0.043102769392308699,0.041147132169576058,0.040438377739860872,0.039362121013256333,0.039860874130463318,0.037340858380364876,0.03663210395064969],"mode":"lines","type":"scatter","name":"ANDROID","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.42222290659357581,0.31803763358073356,0.26549844476609896,0.23701148717316992,0.21258969542052908,0.19830002155769763,0.18524221613131717,0.16895075605925286,0.15789473684210525,0.14622278340673217,0.140710172153614,0.13476640694773798,0.12971574635828895,0.12617412460349234,0.11970681531212467,0.11339348957531335,0.11028302177327462,0.10655661975301038,0.10239906377998829,0.10092082165624711,0.099257799267038274,0.092513319577469125,0.088879307689938708,0.087401065566197533,0.086323180684302919,0.082596778664038681,0.081118536540297492,0.080225431923870535,0.076437436481783749,0.074096886452526864],"mode":"lines","type":"scatter","name":"IOS","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```



<!-- ## level 4 (UV) -->

<!-- Постройте и сравните графики rolling retention и retention rate для тех пользователей, которые пришли в июле и августе. -->

<!-- ```{r} -->
<!-- # чистим пользователей, у которых дата логина раньше даты инсталла -->
<!-- bug_users <- dau[login_dt < install_dt, unique(user_pseudo_id)] -->

<!-- # корректируем таблицу dau -->
<!-- dau <- dau[!(user_pseudo_id %in% bug_users)] -->

<!-- # считаем retention rate (классический, когда имеем возможность логировать каждый заход пользователя) -->
<!-- rrate_stat <- dau[, list(n_users = uniqueN(user_pseudo_id)), by = lifetime] -->
<!-- rrate_stat <- rrolling_stat[lifetime <= 28] -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # считаем rolling retention -->
<!-- # сначала вычисляем максимальную дату захода по каждому пользователю -->
<!-- rrolling <- dau[, list(last_login = max(login_dt)), by = list(user_pseudo_id, install_dt)] -->
<!-- rrolling[, lifetime := as.numeric(last_login - install_dt)] -->

<!-- # считаем количество дней от инсталла до последнего логина -->
<!-- rrolling_stat <- rrolling[, list(n_users = uniqueN(user_pseudo_id)), keyby = lifetime] -->

<!-- # нужна обратная кумулята, так как мы считаем "сколько пришло после дня x" -->
<!-- # а в статистике у нас "сколько пришло в день x" - то есть, для каждого дня надо получить, -->
<!-- # накопительную сумму этого и всех следующих дней. а это делается с помощью обратной кумуляты -->
<!-- # для этого мы переворачиваем значения колонки с помощью rev(), считаем обычную кумуляту -->
<!-- # а потом результат переворачиваем обратно -->
<!-- # чтобы понять результат, попробуйте выражения: 1:5; rev(1:5), cumsum(1:5), cumsum(rev(1:5)), rev(cumsum(rev(1:5))) -->
<!-- rrolling_stat[, n_users_cum := rev(cumsum(rev(n_users)))] -->
<!-- rrolling_stat <- rrolling_stat[lifetime <= 28] -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # собираем обе таблицы ретеншена и рисуем -->
<!-- rr <- merge( -->
<!--   rrate_stat[, list(lifetime, rate = n_users / n_users[lifetime == 0])], -->
<!--   rrolling_stat[, list(lifetime, rolling = n_users_cum / n_users_cum[lifetime == 0])], -->
<!--   by = 'lifetime', -->
<!--   all.x = TRUE -->
<!-- ) -->
<!-- plot_ly(rr, x = ~lifetime, y = ~rate, type = 'scatter', mode = 'lines', name = 'Retention rate') %>% -->
<!--   add_trace(y = ~rolling, name = 'Rolling retention') -->
<!-- ``` -->


<!-- ## level 5 (N) -->

<!-- Постройте графики DAU, MAU и их отношения. Проинтерпретируйте метрику DAU/MAU, что она говорит о проекте? -->

<!-- ```{r, message=FALSE, warning=FALSE} -->
<!-- # считаем DAU -->
<!-- auth_stat <- auth[, list(dau = uniqueN(user_id)), by = login_date] -->

<!-- # считаем MAU -->
<!-- auth_stat[, mau := sapply(login_date, function(x) -->
<!--   auth[login_date %between% c(x - 30, x), uniqueN(user_id)])] -->

<!-- # сортируем -->
<!-- auth_stat <- auth_stat[order(login_date)] -->

<!-- # рисуем график -->
<!-- plot_ly(auth_stat, x = ~login_date, y = ~dau, -->
<!--         type = 'scatter', mode = 'lines', name = 'DAU') %>% -->
<!--   add_trace(y = ~mau, name = 'MAU') %>% -->
<!--   layout(title = 'DAU и MAU проекта', -->
<!--          yaxis = list(rangemode = 'tozero')) -->
<!-- ``` -->


## Домашнее задание

### level 1 (IATYTD)

Внимательно разберите решения заданий (материалы конспекта).


### level 2 (HNTR)
Постройте график ретеншена для когорты пользователей, пришедшей в июне, с разбивкой по источникам привлечения (media_source). Для этого вам потребуются следующие датасеты:

- Инсталлы: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv
- Логины: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv

### level 3 (HMP)
Постройте линейный график retention 1 day (ret1) для всех дневных когорт.
Т.е. по оси OX должна быть дата инсталла, по оси OY -- значение ретеншена первого для пользователей, пришедших в этот день.

### level 4 (UV)
Добавьте на этот график группировку по источникам трафика (media_source).

### level 5 (N)

Постройте и сравните графики rolling retention и retention rate (возьмите данные за логины и инсталлы из практикума).

Для rolling retention необходимо:

- посчитать максимальный лайфтайм пользователя
- посчитать количество пользователей по лайфтайму
- cделать обратную кумулятивную сумму
- cумму поделить на количество установок (для lifetime == 0 значения количества инсталлов и обратная кумсумма должны совпадать)



