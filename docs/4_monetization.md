# Метрики монетизации pt1 {-}

## Запись занятия

<iframe width="560" height="315" src="https://www.youtube.com/embed/8xL2bHOe3pA?si=7xmpZ_4sGFOhWEW4" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Код занятия на Python

https://colab.research.google.com/drive/1gdtpFd3LjzRSsFwPrKP-OARjDXDU3F1v?usp=sharing

## Разбор домашнего задания

### level 2 (HNTR)

Постройте график ретеншена для когорты пользователей, пришедшей в июне, с разбивкой по источникам привлечения (media_source). Для этого вам потребуются следующие датасеты:

- Инсталлы: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv
- Логины: https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv


``` r
library(data.table)
library(plotly)
```

```
## Loading required package: ggplot2
```

```
## 
## Attaching package: 'plotly'
```

```
## The following object is masked from 'package:ggplot2':
## 
##     last_plot
```

```
## The following object is masked from 'package:stats':
## 
##     filter
```

```
## The following object is masked from 'package:graphics':
## 
##     layout
```

``` r
# чтобы загрузка не обрывалась по таймауту, если слабый интернет
options(timeout=360)

# installs <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv')
installs <- fread('./data/installs.csv')

# logins <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv')
logins <- fread('./data/logins.csv')

# выделяем инсталлы в июне
installs_june <- installs[dt >= '2022-06-01' & dt < '2022-07-01']

# считаем количество пользователей по платформам
installs_june[, uniqueN(user_pseudo_id), keyby = media_source]
```

```
## Key: <media_source>
##         media_source    V1
##               <char> <int>
## 1:                   36169
## 2:      Facebook Ads  1297
## 3:      applovin_int 36714
## 4: googleadwords_int  7767
## 5:           organic    32
## 6:             other  6869
## 7:      unityads_int 21932
```

``` r
# при необходимости укрупняем
installs_june[media_source %in% c('organic', 'other') | is.na(media_source), media_source := 'organic']

# смотрим, нет ли тех, кто два раза устанавливал приложение
installs_june[, list(n_install_dates = length(dt)), user_pseudo_id][n_install_dates > 1]
```

```
##                       user_pseudo_id n_install_dates
##                               <char>           <int>
##  1: 000ee53a25d9b57b29a8513070325bba               2
##  2: 0114C14103154E4B8202B09684ECBC1F               2
##  3: 01958D392F90428AA0DAF9D94CC699DE               2
##  4: 09B886173CAF46E7B99C2927CE954E9B               2
##  5: 0DA2A73360594B5D94C77489A563C9C9               2
##  6: 1A041DCE27EC4DE984379C91778615E1               2
##  7: 1CB08A3B991A41848CF193759534A8E3               2
##  8: 1FC5CCB7EAA34A1CA4D4FB9731AAD6B4               2
##  9: 2488537605DD48DC89CB9AE2A7F056DC               2
## 10: 2585F39E330445CCB04D86C8874E04AE               2
## 11: 2E7FE3A85A434C19AE66C5F5A9909488               3
## 12: 30B149EB924045D7B710BB0ECCD3E3C8               2
## 13: 330704BC3B27431B910C5EFF17F7E224               2
## 14: 34cd9bf8909ccd8ff7845e57374284d1               2
## 15: 369FD7EBC865452CB1B33E5E98AC447C               2
## 16: 36D082CC8AB7447683877B1AFED0EDDB               2
## 17: 382548ABD43A4CC3956408AA15065DD5               2
## 18: 3B22021A23624273B976BB68F7BC133E               2
## 19: 3B41BA33DDCA463180F1288B1FDAB9E5               2
## 20: 3CFDCBE58131436483C5DB672E0C8BA5               2
## 21: 3E5DBDEB38FE408FA281C75B5B33D08A               2
## 22: 41E59CD840224F4286041CF23454D1A5               2
## 23: 42F53713F7B04EF8ADA81A51EDFAA0FC               2
## 24: 453D178E341A45409852BFBEF7668FCA               2
## 25: 4df8d48b980fb52e7143b8f4f6a86eec               2
## 26: 53d5883b315f11beb96e759eeb6c6946               2
## 27: 541291B4FC0A472C8A18F33FCBB578E7               2
## 28: 55734100B47F414CBB3575028EC0E887               2
## 29: 58E14628B03046219960479EA035BAC4               2
## 30: 5f86721f15e1fe055162a1251f2f8b01               2
## 31: 67A5140641B44E26B9F9699A767EAA1B               2
## 32: 696f7a53d58e73d2a1b9c5ff841741d6               2
## 33: 6F22E223CB3D4DEF9CE5F64073099A8C               3
## 34: 7044781DFEC247C79D9641EFB09CDF79               2
## 35: 78264f9fd5ab87d279dc8f7c98279f55               2
## 36: 79f6234ccd8fc0ccfcd4058a9d4173f6               2
## 37: 7F25AD2C389542048506DF670BD714BD               2
## 38: 8159da026a6e5393b11783bb56df4c14               2
## 39: 822abdbc7bef93fbe985f4e89651dd75               2
## 40: 83F7F0494B2F4D49B934C12A92B4B299               2
## 41: 84e435c0c8689635cf96ceeabf52c534               2
## 42: 854366FB9D794A83B85B666A808DF8C2               2
## 43: 8C03EE3FBBFC472BB26DB331567DAA6A               2
## 44: 8FD70E7743B74FDA8B398B8E59B6D393               2
## 45: 908C0586AFD14790A2FEAD8380D5E5AC               2
## 46: 9655A5286F2D4782BB95B97C4443AB19               2
## 47: 98AAE0DB60B44B649FB45DAFF50E5756               2
## 48: 9B1CAF9AB0B2438A92D7FB377BDF1CD5               2
## 49: 9DC9EC1BE76D48AD9161A8FDA1AD8F5D               2
## 50: 9EBF8F8182D84FBD99DE634AC3467F7E               2
## 51: A1084F73187648EFAAD54B3FC01A25EF               2
## 52: A3DD0C1CACA4442085DBFFC493DBEFDE               2
## 53: A7072DB51E414373B45AF4495BE5E30D               2
## 54: ABD07667D3124C969E098EED5FFD25B2               2
## 55: AE7CF2B145C94D94A2782A4986A56C7A               2
## 56: BA8BE90B36464ED48B1F6596C8B9218A               2
## 57: BCF666CE7D004703B1C7A998E0029B3D               2
## 58: BD2FC2B3E09441AAA0C8DAAF079DFEE7               2
## 59: BEE44FD3EB6B464FB19E89B3DD18C1D8               2
## 60: CB97620A41514DD6A572406AC15DA962               3
## 61: CEB5B07C3DE244B4B042D7663C4957F2               2
## 62: D367DC87B0AF47CEB44219CB5C16B136               2
## 63: D8DD91C418E644E6BD3A2A46DE12DD86               3
## 64: DF4612D16A6C49A08C1C7F64B43ADCF0               2
## 65: E5E18D1017294B0992C09A454C9519A8               2
## 66: ECDC46825D71492794912D761A78A71F               2
## 67: EF4084E36ABA4A889CC21272B1791355               2
## 68: F2FB00FFF2C74EA4B8BC87992CED3B6A               2
## 69: F559AD32A74E411C9B60873CCC3614A1               2
## 70: F73BD84C3713442187AF3289DA2D2172               2
## 71: FEE12ECCA2E94760909C8F64EFEF066B               2
## 72: FFFD930C3F9F4AB7B9786983044292FE               2
## 73: a43d9e6b9741ccb23d0138d3d7ba325a               2
## 74: a92b088adfb0f9374dcfec4f884c76d9               2
## 75: add417438334536d4e41fee42cecbeac               2
## 76: b35107c77a6c0a3e5e55dc980c0c435c               2
## 77: b8b9848ce34f9661eae6b471522d5265               2
## 78: b929015e9c4eeee3e1d4a7e6a22b39d2               2
## 79: cf38d8f4f997cc7a2bde1cf6b9636a51               2
## 80: d101bd547e90e2a43ffbe29cdc0d7c6a               2
## 81: de47c1adf204ee72a6745901052a26ae               2
## 82: df7e04c01ef23152ce370e6655de6133               2
## 83: ee01a31f793d9200e110ba607747d2d2               2
## 84: f0d4270e629a31d5f73ba47d6fb8de07               2
## 85: f2cd8d5642834168fa5dcfeb42a4b5d6               2
## 86: f43c58ff000c5ba637bb622848c2597b               2
## 87: fa6827f8ebd2805fe69ac2fcdafbe18a               2
## 88: fd72559f6d926b4e770290d48fb422e5               2
##                       user_pseudo_id n_install_dates
```

``` r
users_reinstalls <- installs_june[, list(n_install_dates = length(dt)), user_pseudo_id][n_install_dates > 1, unique(user_pseudo_id)]

# чистим таких пользователей
# installs_june <- installs_june[!user_pseudo_id %in% users_reinstalls]

# можно удалить, можно взять первый инсталл
# installs_june <- installs_june[order(user_pseudo_id, dt)]
# installs_june <- installs_june[, .SD[1], by = user_pseudo_id]

# присоединяем к установкам логины
installs_june <- merge(
  installs_june,
  logins,
  by = c('user_pseudo_id', 'platform'), all.x = TRUE
)
# вычисляем лайфтайм
installs_june[, lifetime := login_dt - dt]

# ищем пользователей, у которых логин был раньше даты инсталла
installs_june[login_dt < dt, uniqueN(user_pseudo_id)]
```

```
## [1] 204
```

``` r
# чистим таких пользователей
installs_june <- installs_june[!user_pseudo_id %in% installs_june[login_dt < dt, unique(user_pseudo_id)]]

# еще одна чистка, для красоты -- берем только тех пользователей, у которых есть lifetime = 0
installs_june <- installs_june[user_pseudo_id %in% installs_june[lifetime == 0, unique(user_pseudo_id)]]

# считаем количество вернувшихся на кайждый день лайфтайма
installs_june_stat <- installs_june[, list(returned = uniqueN(user_pseudo_id)), by = list(media_source, lifetime)]

# так как выше почистили путешественников во времени, эта фильтрация избыточна
installs_june_stat <- installs_june_stat[lifetime >= 0]

# считаем количество инсталлов, data.table-way
installs_june_stat[, total_users := returned[lifetime == 0], by = media_source]

# # тоже количество инсталлов, староверы/python-way
# installs_june_stat <- merge(
#   installs_june_stat,
#   installs_june_stat[lifetime == 0, list(media_source, total_users = returned)],
#   by = 'media_source', all.x = TRUE
# )

# считаем собственно ретеншен
installs_june_stat[, ret := returned / total_users]

# сортируем для красоты
installs_june_stat <- installs_june_stat[order(lifetime)]


# рисуем график, попутно накладываем ограничение на количество дней лайтайма
plot_ly(installs_june_stat[lifetime <= 30], 
        x = ~lifetime, y = ~ret, color = ~media_source,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Ретеншен июньской когорты в зависимости от источников трафика',
    yaxis = list(rangemode = 'tozero')
    ) %>%
  config(displayModeBar = FALSE)  
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-91295bfa5cb7a9868214" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-91295bfa5cb7a9868214">{"x":{"visdat":{"cbb951e223ff":["function () ","plotlyVisDat"]},"cur_data":"cbb951e223ff","attrs":{"cbb951e223ff":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Ретеншен июньской когорты в зависимости от источников трафика","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.27805752325680633,0.19928309294187932,0.16224289493897756,0.14150379790048648,0.12901482176893972,0.11908622798782396,0.11058006884583653,0.1012204489203721,0.09575829990611931,0.088617678017695087,0.084122784558049557,0.080339108417968194,0.076270945350061167,0.074706267247019995,0.069670848624505705,0.067850132286421436,0.066399248954510534,0.064720776080339104,0.061506073795909076,0.060965548633040309,0.058945691445478079,0.055930130010526019,0.054849079684788485,0.052487838183835456,0.051890415635401553,0.049586071520013653,0.048874854200449493,0.049557622827231092,0.046911894398452392,0.045148075445933258],"mode":"lines","type":"scatter","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.43022359290670781,0.3084040092521203,0.23824209714726291,0.19892058596761758,0.17116422513492677,0.16576715497301464,0.15034695451040864,0.12259059367771781,0.10717039321511179,0.10562837316885119,0.090979182729375482,0.077872012336160368,0.085582112567463384,0.075558982266769464,0.07632999228989977,0.067848882035466462,0.064764841942945253,0.059367771781033155,0.060138781804163453,0.048573631457208943,0.047802621434078645,0.048573631457208943,0.043176561295296838,0.042405551272166539,0.040092521202775636,0.043176561295296838,0.037008481110254433,0.036237471087124135,0.036237471087124135,0.032382420971472627],"mode":"lines","type":"scatter","name":"Facebook Ads","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.36130817058807418,0.25829247582787807,0.20959215535895259,0.17987345586019884,0.15990577665781042,0.14821003040346217,0.1355282259168972,0.12235339231422389,0.11556054671450876,0.10515215426333233,0.097975841573310685,0.093401626996083162,0.089703908625270487,0.086334876331863375,0.080692432003067735,0.076748199074200885,0.072940918677586356,0.068914514229368104,0.066915007258484205,0.064422471171491955,0.064230737626338713,0.060231723684570929,0.056095757210550823,0.054972746446081786,0.053137582513900682,0.052370648333287681,0.051001123010764468,0.05080938946561122,0.046344736914185544,0.045632583746473471],"mode":"lines","type":"scatter","name":"applovin_int","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.37508444804756114,0.27144980408052966,0.2179435211457911,0.18916362653695445,0.16781516011349817,0.15133090122956358,0.14065666801783544,0.12417240913390082,0.11701121470071613,0.11066072152411836,0.10147277394946629,0.096743683286042423,0.092419943250912046,0.088906904472368598,0.08134035941089042,0.07796243750844481,0.080529658154303477,0.07242264558843399,0.072152411836238342,0.069450074314281851,0.068234022429401436,0.064991217403053636,0.059991892987434133,0.060802594244021076,0.058235373598162408,0.055533036076205917,0.05526280232401027,0.054181867315227672,0.053236049182542898,0.053641399810836377],"mode":"lines","type":"scatter","name":"googleadwords_int","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.4705185185185185,0.34859259259259257,0.30118518518518517,0.26755555555555555,0.24059259259259258,0.22459259259259259,0.21125925925925926,0.1965925925925926,0.18118518518518517,0.17229629629629631,0.16444444444444445,0.15377777777777779,0.152,0.1491851851851852,0.14755555555555555,0.1322962962962963,0.1282962962962963,0.12622222222222224,0.1162962962962963,0.11896296296296296,0.11377777777777778,0.10666666666666667,0.10488888888888889,0.10251851851851852,0.098518518518518519,0.092592592592592587,0.095851851851851855,0.092740740740740735,0.089629629629629629,0.089925925925925923],"mode":"lines","type":"scatter","name":"organic","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.35566548881036514,0.23392226148409895,0.17865724381625442,0.15137809187279153,0.13130742049469965,0.11976442873969376,0.10944640753828033,0.099081272084805661,0.088527679623085984,0.082402826855123679,0.076183745583038864,0.072037691401648993,0.0672791519434629,0.064263839811542989,0.059175500588928148,0.055736160188457007,0.050600706713780919,0.049045936395759715,0.045889281507656067,0.047538280329799766,0.044994110718492346,0.042073027090694937,0.04023557126030624,0.039528857479387516,0.037550058892815076,0.037267373380447583,0.03420494699646643,0.035147232037691399,0.033733804475853946,0.032273262661955245],"mode":"lines","type":"scatter","name":"unityads_int","marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"line":{"color":"rgba(255,217,47,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```



### level 3 (HMP)
Постройте линейный график retention 1 day (ret1) для всех дневных когорт.
Т.е. по оси OX должна быть дата инсталла, по оси OY -- значение ретеншена первого для пользователей, пришедших в этот день.


``` r
daily_ret <- merge(
  installs,
  logins,
  by = c('user_pseudo_id', 'platform'), all.x = TRUE
)

# считаем лайфтайм
daily_ret[, lifetime := login_dt - dt]

# ищем пользователей, у которых логин был раньше даты инсталла
daily_ret[login_dt < dt, uniqueN(user_pseudo_id)]
```

```
## [1] 444
```

``` r
# чистим таких пользователей
daily_ret <- daily_ret[!user_pseudo_id %in% daily_ret[login_dt < dt, unique(user_pseudo_id)]]

# еще одна чистка, для красоты -- берем только тех пользователей, у которых есть lifetime = 0
daily_ret <- daily_ret[user_pseudo_id %in% daily_ret[lifetime == 0, unique(user_pseudo_id)]]

# считаем, сколько вернулось в каждой дневной когорте по дням от инсталла
daily_ret_stat <- daily_ret[, list(returned = uniqueN(user_pseudo_id)), by = list(dt, login_dt, lifetime)]

# из-за нашей чистки странных пользователей у нас пропали некоторые даты с lifetime = 0
# для красоты их можно восстановить, но необязательно

# считаем количество всего пользователей в когорте
# daily_ret_stat[, total_users := returned[lifetime == 0], by = dt]

daily_ret_stat <- merge(
  daily_ret_stat[lifetime == 0, list(dt, total_users = returned)],  
  daily_ret_stat,
  by = 'dt', all.x = TRUE
)

# считаем ретеншен
daily_ret_stat[, ret := returned / total_users]

# сортируем
daily_ret_stat <- daily_ret_stat[order(dt, lifetime)]
# daily_ret_stat <- daily_ret_stat[!dt %in% c('2022-06-25', '2022-07-06', '2022-07-20')]

# рисуем простой график
# plot_ly(daily_ret_stat[lifetime == 1], 
#         x = ~dt, y = ~ret,
#         type = 'scatter', mode = 'lines') %>%
#   layout(
#     yaxis=list(rangemode = 'tozero')
#   )


# чтобы сортирвока линий была нормальная
ret_days <- c(1, 3, 7, 14, 30)

daily_ret_stat_plot <- daily_ret_stat[lifetime %in% ret_days]
daily_ret_stat_plot[, lifetime_cat := factor(lifetime, levels = ret_days)]


# рисуем график ретеншена дневных когорт
plot_ly(daily_ret_stat_plot, 
        x = ~dt, y = ~ret, color = ~lifetime_cat,
        type = 'scatter', mode = 'lines') %>%
  layout(
    title = 'Retention rate дневных когорт',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)  
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-102609b59a728e605a05" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-102609b59a728e605a05">{"x":{"visdat":{"cbb95ff494dd":["function () ","plotlyVisDat"]},"cur_data":"cbb95ff494dd","attrs":{"cbb95ff494dd":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Retention rate дневных когорт","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30"],"y":[0.35145675613672861,0.36338171632289279,0.37630662020905925,0.3685413808870599,0.36818642350557246,0.35889219501029984,0.3801566579634465,0.35730698529411764,0.35748548346377179,0.34804610626932808,0.34497505345687812,0.34095405583644756,0.36141370128298234,0.34182015167930663,0.35153232037084731,0.31954523463957424,0.31920773836941502,0.32720057720057721,0.30930642319397728,0.32207168581718404,0.32194480946123522,0.34337140879196953,0.32213578500707213,0.32496914849856029,0.31026785714285715,0.29846449136276393,0.32225913621262459,0.31338818249813016,0.300561797752809,0.30319148936170215,0.32576985413290116,0.33821138211382112,0.35510887772194305,0.31568228105906315,0.35129740518962077,0.35496183206106868,0.40476190476190477,0.35384615384615387,0.3176895306859206,0.30691056910569103,0.34553775743707094,0.35805084745762711,0.32914572864321606,0.317016317016317,0.31951219512195123,0.41277641277641275,0.33410138248847926,0.3704663212435233,0.34660421545667447,0.36690647482014388,0.35909090909090907,0.375,0.38847117794486213,0.38337801608579086,0.35681818181818181,0.35670103092783506,0.36266094420600858],"mode":"lines","type":"scatter","name":"1","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28"],"y":[0.1828401009405827,0.22154316271963331,0.22735191637630661,0.21604938271604937,0.21681864235055726,0.20462348363469901,0.21540469973890339,0.19715073529411764,0.2055036606917445,0.21113297722800112,0.1903064861012117,0.20641899318531545,0.20091987412248849,0.19257854821235104,0.19778521761524595,0.1833575229801645,0.18010133578995854,0.18199855699855699,0.1750760852154413,0.1939632996055565,0.17630310994305737,0.18206992038767739,0.19024045261669023,0.18140682846565198,0.16919642857142858,0.14971209213051823,0.16411960132890366,0.17352281226626776,0.19662921348314608,0.19326241134751773,0.17504051863857376,0.20813008130081301,0.22780569514237856,0.19959266802443992,0.18762475049900199,0.22328244274809161,0.26007326007326009,0.20854700854700856,0.18592057761732853,0.17073170731707318,0.20594965675057209,0.2097457627118644,0.24371859296482412,0.20279720279720279,0.19756097560975611,0.24078624078624078,0.20506912442396313,0.21761658031088082,0.20374707259953162,0.23021582733812951,0.20681818181818182,0.21354166666666666,0.22305764411027568,0.19571045576407506,0.21818181818181817],"mode":"lines","type":"scatter","name":"3","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-21","2022-07-22","2022-07-23","2022-07-24"],"y":[0.13466391374168388,0.15457091927680164,0.13937282229965156,0.13648834019204389,0.13819655521783181,0.13069352254520486,0.13916449086161881,0.13327205882352941,0.1363292097955062,0.13972448692718584,0.13162271323354716,0.13343591998241372,0.13386589203582669,0.12242686890574214,0.13674993561679114,0.11683599419448476,0.11469368954398894,0.11562049062049062,0.11645042447541246,0.11919053335619963,0.11651335961454228,0.12564901349948079,0.12270155586987271,0.11024269847799259,0.11205357142857143,0.096449136276391553,0.099003322259136217,0.11742707554225879,0.12780898876404495,0.12056737588652482,0.1312803889789303,0.15934959349593497,0.15075376884422109,0.1384928716904277,0.1157684630738523,0.16412213740458015,0.18498168498168499,0.16923076923076924,0.11732851985559567,0.12601626016260162,0.15560640732265446,0.15254237288135594,0.20100502512562815,0.12820512820512819,0.15121951219512195,0.17444717444717445,0.14976958525345621,0.17616580310880828,0.13583138173302109,0.11750599520383694,0.13863636363636364],"mode":"lines","type":"scatter","name":"7","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17"],"y":[0.083964211975223677,0.092946269416857658,0.090301974448315905,0.094650205761316872,0.088145896656534953,0.085145342183566036,0.095561357702349872,0.09122242647058823,0.087856601868215103,0.081529378689907228,0.081967213114754092,0.086612442295009889,0.081578310336480275,0.083694474539544955,0.087303631212979654,0.066763425253991288,0.070704744357438967,0.073593073593073599,0.078327727054300814,0.075973246441433717,0.075777485764345162,0.081343025268258914,0.081329561527581334,0.079802550390785681,0.06294642857142857,0.062859884836852203,0.067109634551495018,0.070306656694091252,0.099719101123595499,0.095744680851063829,0.11183144246353323,0.11869918699186992,0.12060301507537688,0.10183299389002037,0.083832335329341312,0.1431297709923664,0.13553113553113552,0.11452991452991453,0.090252707581227443,0.081300813008130079,0.12814645308924486,0.1059322033898305,0.15326633165829145,0.086247086247086241,0.12195121951219512],"mode":"lines","type":"scatter","name":"14","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01"],"y":[0.042211516402844686,0.04710975299210593,0.049941927990708478,0.052812071330589849,0.053900709219858157,0.04623483634699016,0.053263707571801565,0.049172794117647058,0.045443069931835396,0.041326960922125386,0.045854122119268231,0.045504506484941747,0.048172355361897845,0.046316359696641385,0.047901107391192375,0.035800677310111273,0.042376784891754948,0.046176046176046176,0.040525388435047251,0.045446750128622877,0.047306176084099871,0.039113880235375563,0.044908062234794911,0.045660222130810363,0.041964285714285711,0.035028790786948177,0.037209302325581395,0.052356020942408377,0.050561797752808987,0.049645390070921988],"mode":"lines","type":"scatter","name":"30","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 5 (N)

Постройте и сравните графики rolling retention и retention rate (возьмите данные за логины и инсталлы из практикума).



``` r
# сначала считаем просто ret1 по всей июньской когорте, без разбивки по каналм привлечения

# оставляем группировку только по дням лайфтайма
retention_type <- installs_june[, list(returned = uniqueN(user_pseudo_id)), by = list(lifetime)]

# считаем количество инсталлов, data.table-way
retention_type[, total_users := returned[lifetime == 0]]

# считаем собственно ретеншен
retention_type[, ret_rate := returned / total_users]
```

Для rolling retention необходимо:

- посчитать максимальный лайфтайм пользователя
- посчитать количество пользователей по лайфтайму
- cделать обратную кумулятивную сумму
- cумму поделить на количество установок (для lifetime == 0 значения количества инсталлов и обратная кумсумма должны совпадать)



``` r
# считаем rolling retention
# считаем количество пользователей, в зависимости от того, на какой максимальный день от логина они вернулись
rrolling <- installs_june[, list(lifetime = max(lifetime)), by = list(user_pseudo_id, dt)]

# считаем количество дней от инсталла до последнего логина
rrolling_stat <- rrolling[, list(n_users = uniqueN(user_pseudo_id)), keyby = lifetime]

# нужна обратная кумулята, так как мы считаем "сколько пришло после дня x"
# а в статистике у нас "сколько пришло в день x" - то есть, для каждого дня надо получить,
# накопительную сумму этого и всех следующих дней. а это делается с помощью обратной кумуляты
# для этого мы переворачиваем значения колонки с помощью rev(), считаем обычную кумуляту
# а потом результат переворачиваем обратно
# чтобы понять результат, попробуйте выражения: 1:5; rev(1:5), cumsum(1:5), cumsum(rev(1:5)), rev(cumsum(rev(1:5)))
rrolling_stat[, returned_after := rev(cumsum(rev(n_users)))]

# или более простой вариант
rrolling_stat = rrolling_stat[order(-lifetime)]
rrolling_stat[, returned_after_2 := cumsum(n_users)]
rrolling_stat = rrolling_stat[order(-lifetime)]

# проверяем
rrolling_stat[, all.equal(returned_after, returned_after_2)]
```

```
## [1] TRUE
```



``` r
# объединяем
retention_type <- merge(
  retention_type,
  rrolling_stat,
  by = 'lifetime',
  all.x = TRUE
)

retention_type[, ret_rolling := returned_after / total_users]
retention_type <- retention_type[lifetime <= 30]

# и рисуем
plot_ly(retention_type, x = ~lifetime, y = ~ret_rate, type = 'scatter', mode = 'lines', name = 'Retention rate') %>%
  add_trace(y = ~ret_rolling, name = 'Rolling retention')  %>%
  layout(
    title = 'Retention rate vs Rolling retention, июньская когорта',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)  
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-7d20ad8783f396af8e8b" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-7d20ad8783f396af8e8b">{"x":{"visdat":{"cbb91658d557":["function () ","plotlyVisDat"]},"cur_data":"cbb91658d557","attrs":{"cbb91658d557":{"x":{},"y":{},"mode":"lines","name":"Retention rate","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"},"cbb91658d557.1":{"x":{},"y":{},"mode":"lines","name":"Rolling retention","alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter","inherit":true}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Retention rate vs Rolling retention, июньская когорта","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"ret_rate"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.34176105157246639,0.24149612768039286,0.19478829165628203,0.16816667128206547,0.14998199994461522,0.13836965652202007,0.1275696232911486,0.11568958673718996,0.107926485927649,0.09989569198674457,0.093507980024553919,0.088781811636343494,0.08496949221382219,0.082200252923855147,0.077058698642149662,0.073181763636195801,0.070310985572263299,0.067357130329631781,0.064394044289367042,0.063544810907110477,0.061910959726029925,0.058357102637238881,0.055735556109403415,0.054350936464419894,0.052698623688072883,0.051120157292791672,0.049938615195739063,0.050003230779171626,0.047104760322339456,0.046006295403985861],"mode":"lines","name":"Retention rate","type":"scatter","marker":{"color":"rgba(31,119,180,1)","line":{"color":"rgba(31,119,180,1)"}},"error_y":{"color":"rgba(31,119,180,1)"},"error_x":{"color":"rgba(31,119,180,1)"},"line":{"color":"rgba(31,119,180,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[1,0.48396148911227421,0.3933796719374521,0.34646875836541036,0.31436404419705904,0.29019781599327998,0.2699639075812541,0.25171462066037126,0.23585611032649331,0.2227206852944163,0.21153295856294943,0.20133292717823748,0.19224982230714557,0.18372056529404707,0.1754866938052117,0.16772359299567074,0.16076357158022025,0.15439432121329605,0.1482835331801021,0.14282813177886702,0.1376773466995283,0.13214809891722742,0.12698808304025549,0.12233576103311088,0.118458826027157,0.11433265948510611,0.11022495453832165,0.10641263511580036,0.10297877839624121,0.098871073449456767,0.095095677217468366],"mode":"lines","name":"Rolling retention","type":"scatter","marker":{"color":"rgba(255,127,14,1)","line":{"color":"rgba(255,127,14,1)"}},"error_y":{"color":"rgba(255,127,14,1)"},"error_x":{"color":"rgba(255,127,14,1)"},"line":{"color":"rgba(255,127,14,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

## Метрики монетизации

### Gross / Net

Gross - общая сумма всех платежей. Обычно полезно для финансистов и прочей отчетности.

Net (revenue) - сумма платежей после вычета налогов и комиссии магазина приложений. Полезно для вычисления метрик ARPU/ARPPU и их сравнения со стоимостью закупки пользователей (т. е. для оценки юнит-экономики и окупаемости проекта).

### Конверсия

Обычно под конверсией понимают ситуацию, когда пользователь меняет один статус на другой. Например, становится из неплатящего платящим пользователем (совершает платеж). Нередко говорят "конверсия в корзину" и подобно -- то есть, какая доля пользователей после просмотра товаров перешла в корзину (готова сделать платеж). 

Конверсия в платящих (здесь и далее мы говорим про это) считается по такой формуле:
Conversion = N Paying Users / N Users


### Практикум

Посчитать, какая доля пользователей стала платящими в интервале 7 дней о инсталла, должно получиться 1 число.
Игнорируйте install_dt в табличке payments, используйте dt из installs


``` r
payments <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv')

# рисоединяем к инсталлам платежи
conversion <- merge(
  installs,
  payments,
  by = c('user_pseudo_id', 'platform'), all.x = TRUE
)

# считаем лайфтайм
conversion[, lifetime := pay_dt - dt]

# так как хотим считать метрику на 7 день от инсталла, то мы должны проконтролировать
# что все пользователи могли прожить столько дней в приложении
# поэтому оставляем инсталлы только по 2022-07-24
conversion <- conversion[dt <= '2022-07-24']


# совершенно примитивным способом считаем, сколько было пользователей, кто сделал платеж
# до седьмого дня от инсталла включительно
# при этом сюда не попадут пользователи, которые не делали платежей, так как сравнение lifetime <= 7
# отсекает значения, когда lifetime is null (нет значений, так как не платил и нет дату платежа)
conversion[lifetime <= 7, uniqueN(user_pseudo_id)] / conversion[, uniqueN(user_pseudo_id)]
```

```
## [1] 0.01866886
```

``` r
# синтаксически другой способ расчета цифры, более data.table-way
conversion[, uniqueN(user_pseudo_id[lifetime <= 7]) / uniqueN(user_pseudo_id)]
```

```
## [1] 0.01867702
```

## Домашнее задание

### level 1 (IATYTD)

Внимательно разберите решения заданий (материалы конспекта).


<!-- ### level 2 (HNTR) -->

<!-- ### level 3 (HMP) -->

<!-- ### level 4 (UV) -->

<!-- ### level 5 (N) -->


### level 2 (HNTR)

На основе данных по [платежам](https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv) нарисуйте [area plot](https://en.wikipedia.org/wiki/Area_chart) подневную структуру гросса проекта, в котором цветами выделите группы пользователей по количеству дней с момента инсталла:

-   группа 1: 0 дней с инсталла

-   группа 2: 1-7 дней с момента инсталла

-   группа 3: 8-28 дней с инсталла

-   группа 4: более 28 дней с инсталла

Решение аналогично такому же заданию на расчет структуры DAU.



### level 3 (HMP)
Посчитайте по каждой платформе конверсию в платящих в день инсталла. Когорта -- пришедшие в июне.

Делать аналогично динамике ретеншена первого дня.


### level 4 (UV)

Постройте график накопительной конверсии для пользователей, кто пришел в июне.
Для этого надо сначала посчитать, в какой день от инсталла пользователь сделал платеж (lifetime.
Потом посчитать, сколько пользователей сделало первый платеж в 0-30 дни от инсталла (new payers).
Посчитать накопительную сумму по количеству пользователей (cumulative new payers).
Посчитать отношение cumulative new users / total users
Нарисовать график.

### level 5 (N)

Постройте график накопительной конверсии в когорте июньскийх пользователей с разбивкой по источнику пользователей.

