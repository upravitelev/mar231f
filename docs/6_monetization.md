# Метрики монетизации pt.3 {#c6_monetization}

## Запись занятия {-}

<iframe width="560" height="315" src="https://www.youtube.com/embed/pHv379smESs?si=mcGL0VShCW0D4cFn" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Код занятия на Python

https://colab.research.google.com/drive/1P36fEEJQHb-q5yKR9ieywopqd2USJ39b


## Разбор домашнего задания

Датасеты:

``` r
library(data.table)
library(plotly)

# импортируем данные
# installs <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/installs.csv')
installs <- fread('./data/installs.csv')

# payments <- fread('https://gitlab.com/hse_mar/mar211f/-/raw/main/data/payments_custom.csv')
payments <- fread('./data/payments.csv')

# делаем рыбу, чтобы учесть потерянные дни, в которых не было платежей
arpu_fish <- data.table(
  dt = seq(as.Date('2022-06-01'), as.Date('2022-07-31'), by = 1)
)
arpu_fish <- arpu_fish[, list(lifetime = 0:30), by = dt]


# корректируем медиасорсы
installs[media_source %in% c('organic', 'other') | is.na(media_source), media_source := 'organic']
```


### level 2 (HNTR)

Постройте график накопительной конверсии в когорте июньских пользователей с разбивкой по источнику пользователей.


``` r
# к платежам присоединяем дату инсталла и источник трафика
conversion <- merge(
  payments,
  installs[, list(user_pseudo_id, media_source, dt)],
  by = 'user_pseudo_id', all.x = TRUE
)

# берем июньскую когорту и ограничиваем даты лайфтайма
conversion[, lifetime := pay_dt - dt]
conversion <- conversion[dt < '2022-07-01']
conversion <- conversion[lifetime >= 0 & lifetime <= 30]

# беру минимальный день от инсталла
# это будет день первого платежа
conversion_stat <- conversion[, list(lifetime = min(lifetime)), by = list(user_pseudo_id, media_source)]

# считаю количество пользователей, которые сделали платеж на этот день
conversion_stat <- conversion_stat[, list(new_payers = uniqueN(user_pseudo_id)), by = list(media_source, lifetime)]

# считаю, сколько всего было пользователей в когорте
# conversion_stat[, total_users := installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]

conversion_stat <- merge(
  installs[dt < '2022-07-01', list(total_users = uniqueN(user_pseudo_id)), by = media_source],
  conversion_stat,
  by = 'media_source', all.x = TRUE
)

# сортирую и считаю накопительное количество пользователей, которые сделали 
# первый платеж в этот день от инсталла
conversion_stat <- conversion_stat[order(media_source, lifetime)]

conversion_stat[, new_payers_cum := cumsum(new_payers), by = media_source]

# считаю накопительную конверсию в платящих
conversion_stat[, cum_conversion := new_payers_cum / total_users]

# рисую
plot_ly(
  conversion_stat, x = ~lifetime, y = ~cum_conversion, type = 'scatter', mode='lines', color = ~media_source
) %>%
  layout(
    title = 'Накопительная конверсия в зависимости от источников трафика',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)    
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-c30fc5393feec6924655" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-c30fc5393feec6924655">{"x":{"visdat":{"8dfc39ff246b":["function () ","plotlyVisDat"]},"cur_data":"8dfc39ff246b","attrs":{"8dfc39ff246b":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Накопительная конверсия в зависимости от источников трафика","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"cum_conversion"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29],"y":[0.005031933423650087,0.0082943957532693735,0.010008570875611711,0.011114490309380961,0.012026873842240592,0.012579833559125217,0.012911609389255993,0.013575161049517543,0.013823992922115624,0.014100472780557937,0.014266360695623323,0.014487544582377174,0.014653432497442562,0.014819320412507948,0.014957560341729105,0.015151096242638724,0.015289336171859879,0.015455224086925267,0.015676407973679116,0.015786999917056042,0.01595288783212143,0.016091127761342586,0.016229367690563743,0.0163676076197849,0.016505847549006056,0.016616439492382978,0.016671735464071441,0.016727031435759904,0.016837623379136829,0.017003511294202217],"mode":"lines","type":"scatter","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,5,7,8,9,11,13,17,27,29],"y":[0.013878180416345412,0.022359290670778721,0.024672320740169621,0.030069390902081727,0.030840400925212029,0.031611410948342328,0.033924441017733231,0.035466461063993829,0.037008481110254433,0.038550501156515038,0.039321511179645337,0.040092521202775636,0.040863531225905934],"mode":"lines","type":"scatter","name":"Facebook Ads","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.0095876232499863805,0.015144086724410307,0.018194694122133245,0.020074086179658987,0.02132701421800948,0.022852317916870948,0.023860107860761561,0.024432096747834614,0.025140273465163152,0.025793975050389498,0.026447676635615841,0.026856240126382307,0.027210328485046575,0.027455466579506455,0.027864030070272921,0.02800021790052841,0.028272593561039387,0.028408781391294873,0.028626681919703655,0.028953532712316828,0.029062482976521219,0.029253145938878903,0.029416571335185489,0.029579996731492073,0.029743422127798659,0.029988560222258539,0.030043035354360734,0.030179223184616223,0.030315411014871712,0.03034264858092281,0.030506073977229396],"mode":"lines","type":"scatter","name":"applovin_int","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,12,13,14,15,16,17,18,20,21,24,25,26,30],"y":[0.0075962405046993689,0.011072486159392301,0.012874983906270118,0.014162482296897129,0.014677481653147934,0.01532123084846144,0.015707480365649541,0.016093729882837648,0.016737479078151152,0.017509978112527358,0.018024977468778163,0.018282477146903568,0.018411226985966266,0.018668726664091671,0.018926226342217072,0.019054976181279774,0.019312475859405175,0.019441225698467877,0.019569975537530579,0.019698725376593278,0.01982747521565598,0.020084974893781384,0.020599974250032186,0.020728724089094888],"mode":"lines","type":"scatter","name":"googleadwords_int","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.017098971163599479,0.028256774380524562,0.032169250833212579,0.035502101144761627,0.038979857991595424,0.039849297203303866,0.040863642950297055,0.042892334444283441,0.043761773655991883,0.044921025938269819,0.04651499782640197,0.047529343573395159,0.047964063179249387,0.049123315461527317,0.049702941602666278,0.050282567743805247,0.051296913490798436,0.051731633096652657,0.052021446167222145,0.052456165773076366,0.052890885378930587,0.053325604984784815,0.053615418055354296,0.054050137661208524,0.054195044196493264,0.054484857267062745,0.054919576872916966,0.055064483408201713,0.055354296478771194,0.055789016084625415],"mode":"lines","type":"scatter","name":"organic","marker":{"color":"rgba(166,216,84,1)","line":{"color":"rgba(166,216,84,1)"}},"textfont":{"color":"rgba(166,216,84,1)"},"error_y":{"color":"rgba(166,216,84,1)"},"error_x":{"color":"rgba(166,216,84,1)"},"line":{"color":"rgba(166,216,84,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,19,20,21,22,23,24,25,27,28],"y":[0.003647638154295094,0.0060641984315155939,0.0071128944008754334,0.0078424220317344518,0.0081615903702352728,0.0090279044318803577,0.0093470727703811787,0.0095294546780959333,0.0097118365858106879,0.0099854094473828189,0.010213386832026264,0.010350173262812328,0.010532555170527085,0.010669341601313149,0.010760532555170527,0.010851723509027904,0.01098850993981397,0.011079700893671348,0.011216487324457413,0.011353273755243479,0.011398869232172169,0.011535655662958234,0.011626846616815612,0.0116724420937443,0.011809228524530367,0.011900419478387743,0.011946014955316433],"mode":"lines","type":"scatter","name":"unityads_int","marker":{"color":"rgba(255,217,47,1)","line":{"color":"rgba(255,217,47,1)"}},"textfont":{"color":"rgba(255,217,47,1)"},"error_y":{"color":"rgba(255,217,47,1)"},"error_x":{"color":"rgba(255,217,47,1)"},"line":{"color":"rgba(255,217,47,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 3 (N)

Посчитайте динамику метрики конверсию в платящих в дни 0, 3, 7, 30 от инсталла.
На графике на оси OX должна быть дата инсталла, на оси OY -- значение конверсии в день инсталла.
Делать аналогично динамике ретеншена первого дня.



``` r
# Посчитайте по каждой платформе динамику метрики конверсии в платящих в день инсталла. 0, 3, 7, 30
# На графике на оси OX должна быть дата инсталла, на оси OY – значение конверсии в день инсталла. 
# Делать аналогично динамике ретеншена первого дня.

conversion_dyn <- merge(
  payments,
  installs[, list(user_pseudo_id, media_source, dt)],
  by = 'user_pseudo_id', all.x = TRUE
)
conversion_dyn <- conversion_dyn[!is.na(dt)]

# берем июньскую когорту и ограничиваем даты лайфтайма
conversion_dyn[, lifetime := pay_dt - dt]

# это будет день первого платежа
conversion_dyn_stat <- conversion_dyn[, list(lifetime = min(lifetime)), by = list(user_pseudo_id, dt)]

# считаю количество пользователей, которые сделали платеж на этот день
conversion_dyn_stat <- conversion_dyn_stat[, list(new_payers = uniqueN(user_pseudo_id)), 
                                           by = list(dt, lifetime)]

# присоединяем рыбу
conversion_dyn_stat <- merge(arpu_fish, conversion_dyn_stat, by = c('dt', 'lifetime'), all.x = TRUE)

# считаю, сколько всего было пользователей в когорте
# conversion_stat[, total_users := installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]

conversion_dyn_stat <- merge(
  installs[, list(total_users = uniqueN(user_pseudo_id)), by = dt],
  conversion_dyn_stat,
  by = 'dt', all.x = TRUE
)

# сортирую и считаю накопительное количество пользователей, которые сделали 
# первый платеж в этот день от инсталла
conversion_dyn_stat <- conversion_dyn_stat[order(dt, lifetime)]
conversion_dyn_stat[is.na(new_payers), new_payers := 0]
conversion_dyn_stat[, new_payers_cum := cumsum(new_payers), by = dt]

# считаю накопительную конверсию в платящих
conversion_dyn_stat[, cum_conversion := new_payers_cum / total_users]

# рисую
plot_ly(
  conversion_dyn_stat[lifetime %in% c(0, 3, 7, 30)], 
  x = ~dt, y = ~cum_conversion, 
  type = 'scatter', mode='lines', color = ~as.character(lifetime)
) %>%
  layout(
    title = 'Накопительная конверсия в дневных когортах',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)    
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-7535418f8ac5c6073940" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-7535418f8ac5c6073940">{"x":{"visdat":{"8dfc2c6369f6":["function () ","plotlyVisDat"]},"cur_data":"8dfc2c6369f6","attrs":{"8dfc2c6369f6":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Накопительная конверсия в дневных когортах","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"cum_conversion"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.0070792418360356244,0.0093908629441624373,0.0075036075036075036,0.0075051171253127128,0.008271131732902965,0.010029633006610439,0.010384215991692628,0.0098353156450137237,0.0077948202162434,0.0069910514541387022,0.006617820846135665,0.0089794130530004377,0.0082046332046332038,0.0088948787061994602,0.007192396609298741,0.0084418716835504108,0.0043548017419206969,0.0053995680345572351,0.0062300319488817887,0.0070121429793056269,0.0039318479685452159,0.0079337702656088298,0.010207673354452657,0.0045026606631191155,0.007575757575757576,0.0035476718403547672,0.0038186157517899762,0.0033025099075297227,0.0029695619896065329,0.0096286107290233843,0.0051635111876075735,0.0031847133757961785,0.011023622047244094,0.009852216748768473,0.01,0.0040733197556008143,0.01556420233463035,0.011194029850746268,0.010638297872340425,0.0067226890756302525,0.013986013986013986,0.0080160320641282558,0.0089686098654708519,0,0.0097323600973236012,0.0044843049327354259,0.0071258907363420431,0.0024096385542168677,0.0022831050228310501,0.0082644628099173556,0.0075949367088607592,0.0045662100456621002,0.0023696682464454978,0.0044247787610619468,0.0076142131979695434,0.0073349633251833741,0.0077319587628865982,0.0044444444444444444,0.0080645161290322578,0.0063424947145877377,0.0022471910112359553],"mode":"lines","type":"scatter","name":"0","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.01644211007079242,0.017766497461928935,0.01875901875901876,0.020468501250852856,0.016743998386120638,0.021198997036699339,0.019470404984423675,0.020814272644098811,0.015841086245914005,0.018176733780760627,0.015126447648310093,0.017520805957074025,0.017133204633204634,0.018867924528301886,0.016439763678397123,0.018089725036179449,0.00962640385056154,0.0093592512598992088,0.012140575079872205,0.013340174448435094,0.0085190039318479693,0.017937219730941704,0.015839493136219639,0.013098649201801064,0.011363636363636364,0.010199556541019957,0.008591885441527447,0.0059445178335535004,0.0074239049740163323,0.012379642365887207,0.010327022375215147,0.0079617834394904458,0.01889763779527559,0.016420361247947456,0.012,0.012219959266802444,0.023346303501945526,0.027985074626865673,0.014184397163120567,0.0084033613445378148,0.015734265734265736,0.01002004008016032,0.017937219730941704,0.0082815734989648039,0.017031630170316302,0.0089686098654708519,0.011876484560570071,0.014457831325301205,0.0045662100456621002,0.01928374655647383,0.015189873417721518,0.011415525114155251,0.011848341232227487,0.0066371681415929203,0.01015228426395939,0.012224938875305624,0.012886597938144329,0.0066666666666666671,0.010080645161290322,0.012684989429175475,0.0022471910112359553],"mode":"lines","type":"scatter","name":"3","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.024434802466316512,0.029441624365482234,0.029437229437229439,0.030247896292926995,0.028041153923744198,0.03122863004330978,0.030633437175493251,0.030192131747483988,0.025898918783002264,0.025727069351230425,0.024344126683999056,0.027595269382391589,0.022924710424710424,0.028840970350404314,0.022861546365271001,0.026772793053545588,0.016731606692642675,0.014578833693304536,0.016134185303514376,0.021378484693004959,0.015945827872433378,0.025181096929975853,0.022527279127067933,0.017191977077363897,0.017518939393939392,0.015077605321507761,0.013842482100238664,0.011228533685601057,0.012620638455827766,0.017881705639614855,0.017211703958691909,0.019108280254777069,0.028346456692913385,0.026272577996715927,0.02,0.022403258655804479,0.029182879377431907,0.033582089552238806,0.031914893617021274,0.01680672268907563,0.022727272727272728,0.014028056112224449,0.022421524663677129,0.012422360248447204,0.024330900243309004,0.011210762331838564,0.0166270783847981,0.019277108433734941,0.0091324200913242004,0.022038567493112948,0.022784810126582278,0.013698630136986301,0.014218009478672985,0.0066371681415929203,0.015228426395939087,0.012224938875305624,0.012886597938144329,0.0066666666666666671,0.010080645161290322,0.012684989429175475,0.0022471910112359553],"mode":"lines","type":"scatter","name":"30","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.01918246174925782,0.021065989847715735,0.021356421356421358,0.025699340459404141,0.022190841234617713,0.024618190107134716,0.023104880581516097,0.02584629460201281,0.02036711088760372,0.020134228187919462,0.017726305837863388,0.021681997371879105,0.020028957528957531,0.022641509433962263,0.019265348060621627,0.022672455378678243,0.011918404767361907,0.011159107271418287,0.01437699680511182,0.015563536856507611,0.011795543905635648,0.021041738530527768,0.017599436818021823,0.015554645927138764,0.014204545454545454,0.012860310421286032,0.011455847255369928,0.0079260237780713338,0.0096510764662212315,0.013755158184319119,0.01549053356282272,0.012738853503184714,0.022047244094488189,0.021346469622331693,0.016,0.018329938900203666,0.025291828793774319,0.027985074626865673,0.017730496453900711,0.011764705882352941,0.02097902097902098,0.014028056112224449,0.020179372197309416,0.010351966873706004,0.019464720194647202,0.011210762331838564,0.0166270783847981,0.016867469879518072,0.0045662100456621002,0.022038567493112948,0.020253164556962026,0.011415525114155251,0.014218009478672985,0.0066371681415929203,0.015228426395939087,0.012224938875305624,0.012886597938144329,0.0066666666666666671,0.010080645161290322,0.012684989429175475,0.0022471910112359553],"mode":"lines","type":"scatter","name":"7","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


Посчитайте по каждой платформе динамику метрики конверсию в платящих в день инсталла.
На графике на оси OX должна быть дата инсталла, на оси OY -- значение конверсии в день инсталла.
Делать аналогично динамике ретеншена первого дня.




``` r
conversion_dyn <- merge(
  payments,
  installs[, list(user_pseudo_id, platform, dt)],
  by = c('user_pseudo_id', 'platform'), all.x = TRUE
)
conversion_dyn <- conversion_dyn[!is.na(dt)]

# берем июньскую когорту и ограничиваем даты лайфтайма
conversion_dyn[, lifetime := pay_dt - dt]


# это будет день первого платежа
conversion_dyn_stat <- conversion_dyn[, list(lifetime = min(lifetime)), by = list(user_pseudo_id, dt, platform)]

# считаю количество пользователей, которые сделали платеж на этот день
conversion_dyn_stat <- conversion_dyn_stat[, list(new_payers = uniqueN(user_pseudo_id)), 
                                           by = list(platform, dt, lifetime)]

conversion_dyn_stat <- merge(arpu_fish, conversion_dyn_stat, by = c('dt', 'lifetime'), all.x = TRUE)

# считаю, сколько всего было пользователей в когорте
# conversion_stat[, total_users := installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]

conversion_dyn_stat <- merge(
  installs[, list(total_users = uniqueN(user_pseudo_id)), by = list(platform, dt)],
  conversion_dyn_stat,
  by = c('dt', 'platform'), all.x = TRUE
)

# сортирую и считаю накопительное количество пользователей, которые сделали 
# первый платеж в этот день от инсталла
conversion_dyn_stat <- conversion_dyn_stat[order(platform, dt, lifetime)]
conversion_dyn_stat[is.na(new_payers), new_payers := 0]
conversion_dyn_stat[, new_payers_cum := cumsum(new_payers), by = list(platform, dt)]

# считаю накопительную конверсию в платящих
conversion_dyn_stat[, cum_conversion := new_payers_cum / total_users]

# рисую
plot_ly(
  conversion_dyn_stat[lifetime == 0], 
  x = ~dt, y = ~cum_conversion, 
  type = 'scatter', mode='lines', color = ~platform
) %>%
  layout(
    title = 'Динамика конверсии в платящих в дневных когортах в день инсталла',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)    
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-7637e4bee1ccc465050e" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-7637e4bee1ccc465050e">{"x":{"visdat":{"8dfc74b96e34":["function () ","plotlyVisDat"]},"cur_data":"8dfc74b96e34","attrs":{"8dfc74b96e34":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Динамика конверсии в платящих в дневных когортах в день инсталла","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"cum_conversion"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-21","2022-07-22","2022-07-24","2022-07-25","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.0041067761806981521,0.0088211708099438652,0.0033881897386253629,0.0043305665824612052,0.0047664442326024788,0.0059502975148757438,0.006331618519984171,0.0073298429319371729,0.0054687499999999997,0.0066904549509366638,0.0046829971181556193,0.0062335958005249343,0.0050468637346791634,0.0045833333333333334,0.0045575389289783516,0.0040363269424823411,0.0030129557095510697,0.0040376850605652759,0.0027700831024930748,0.004377880184331797,0.0019607843137254902,0.0036463081130355514,0.0068306010928961746,0.0021097046413502108,0.0052478134110787176,0.0026581605528973951,0.0034762456546929316,0.001693480101608806,0.0018921475875118259,0.0081799591002044997,0.0027700831024930748,0.0026666666666666666,0.0055710306406685237,0.0089020771513353119,0.0069686411149825784,0.0035087719298245615,0.011029411764705883,0.0095541401273885346,0.0098039215686274508,0.0084269662921348312,0.011661807580174927,0.003003003003003003,0.003952569169960474,0.014084507042253521,0.0042194092827004216,0.0095238095238095247,0.0045662100456621002,0.0039215686274509803,0.0046296296296296294,0.00390625,0.008658008658008658,0.009433962264150943,0.0040322580645161289,0.007575757575757576,0.0040983606557377051,0.0045871559633027525],"mode":"lines","type":"scatter","name":"ANDROID","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-15","2022-07-16","2022-07-17","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30"],"y":[0.013040494166094716,0.010373443983402489,0.013581129378127233,0.012915129151291513,0.014364640883977901,0.017647058823529412,0.018113207547169812,0.014598540145985401,0.011997177134791814,0.0074962518740629685,0.010309278350515464,0.014492753623188406,0.014598540145985401,0.016793893129770993,0.012698412698412698,0.019607843137254902,0.0086206896551724137,0.01092896174863388,0.016592214422463305,0.014598540145985401,0.010912698412698412,0.021276595744680851,0.021705426356589147,0.012797074954296161,0.017632241813602016,0.0080213903743315516,0.0054200542005420054,0.0090090090090090089,0.0068965517241379309,0.012605042016806723,0.0090909090909090905,0.003952569169960474,0.018115942028985508,0.011029411764705883,0.014084507042253521,0.0048543689320388345,0.020661157024793389,0.013513513513513514,0.011627906976744186,0.0041841004184100415,0.017467248908296942,0.018072289156626505,0.015544041450777202,0.0050505050505050509,0.0047846889952153108,0.0047393364928909956,0.018633540372670808,0.0111731843575419,0.0054945054945054949,0.0051813471502590676,0.0054945054945054949,0.014492753623188406,0.017142857142857144,0.0049504950495049506,0.0086206896551724137,0.0087336244541484712],"mode":"lines","type":"scatter","name":"IOS","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


### level 4 (UV)

Постройте и нарисуйте структуру накопительного ARPU для июньских пользователей в зависимости оттого, какие offer_type покупали пользователи. Таким образом мы можем понять, какая товарная категория делает наибольший вклад в кумулятивное ARPU.

ИЛИ

Постройте график накопительного ARPU в когорте июньских пользователей с разбивкой по источнику пользователей.



``` r
# к платежам присоединяем дату инсталла и источник трафика
arpu_june <- merge(
  payments,
  installs[, list(user_pseudo_id, media_source, dt)],
  by = 'user_pseudo_id', all.x = TRUE
)

# берем июньскую когорту и ограничиваем даты лайфтайма
arpu_june[, lifetime := pay_dt - dt]
arpu_june <- conversion[dt < '2022-07-01']
arpu_june <- arpu_june[lifetime >= 0 & lifetime <= 30]


# считаем деньги, которые платили в определенный день от инстала
arpu_june_stat <- arpu_june[, list(gross = sum(gross)), by = list(lifetime, offer_type)]

# считаю, сколько всего было пользователей в когорте
arpu_june_stat[, total_users := installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]

# сортирую и считаю накопительную сумму денег, которую заплатили пользователи
arpu_june_stat <- arpu_june_stat[order(offer_type, lifetime)]
arpu_june_stat[, gross_cum := cumsum(gross), by = offer_type]

# считаю накопительную конверсию в платящих
arpu_june_stat[, cum_ARPU := gross_cum / total_users]

# рисую
plot_ly(
  arpu_june_stat, x = ~lifetime, y = ~cum_ARPU, type = 'scatter', mode='none', stackgroup ='one', color = ~offer_type
) %>%
  layout(
    title = 'Накопительное ARPU по категориям',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)    
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-c3b8425ed50f169be55f" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-c3b8425ed50f169be55f">{"x":{"visdat":{"8dfc7a6ca201":["function () ","plotlyVisDat"]},"cur_data":"8dfc7a6ca201","attrs":{"8dfc7a6ca201":{"x":{},"y":{},"mode":"none","stackgroup":"one","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Накопительное ARPU по категориям","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"cum_ARPU"},"xaxis":{"domain":[0,1],"automargin":true,"title":"lifetime"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.003490070409821269,0.0065473009568514208,0.0090180538003249728,0.012201660949629904,0.01422206174399712,0.01561039898898719,0.017468496118432937,0.0186046217728832,0.0194607329842932,0.020840584943130534,0.021534121682614198,0.022660588553890599,0.023679454775230195,0.024156887524823981,0.024589005235602101,0.025436540891857741,0.026112294638021311,0.027717909369922373,0.028853854486369387,0.029908376963350792,0.031441234879942236,0.033001173497021127,0.033370283444665111,0.034605795269904323,0.035299602816392855,0.035785972197147506,0.036615363784076559,0.037805560570500094,0.038373352590720354,0.039356111211410007,0.039878768730817839],"mode":"none","stackgroup":"one","type":"scatter","name":"category_1","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.031026809893482242,0.064448546669073153,0.095149575735691397,0.11619642534753462,0.13858864415959443,0.15989799602816271,0.17481196966961426,0.19019805018956371,0.20807925618342543,0.22462583498826388,0.23798826502978762,0.25105154359992665,0.26346786423542046,0.27360092074381548,0.28820048745260768,0.30093347174580143,0.31337606066076801,0.32218333634229901,0.33331124751760144,0.3445662574471916,0.35611725943310962,0.36615228380574011,0.37837154721068678,0.38997671059757977,0.39879536017331546,0.40799313955587552,0.41921213215381742,0.42898826502978776,0.43716663657699845,0.44885656255641715,0.45626900162484108],"mode":"none","stackgroup":"one","type":"scatter","name":"category_2","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.016331016428958324,0.027841307095143576,0.033685773605343985,0.038078895107420178,0.040508575555154427,0.042985647228741722,0.046780104712041963,0.050214118071854198,0.052467683697418388,0.054035927062646767,0.055793193717277562,0.056775139916952592,0.058407113197328116,0.060227929229102799,0.061246073298429397,0.062039447553710131,0.063121321538183867,0.064599927784798769,0.065465156165372893,0.06679969308539456,0.068665643617981664,0.07034284166817123,0.07159595594872728,0.072948275862069048,0.074805831377505044,0.076401516519227386,0.078006409099115437,0.079223686586026437,0.080558223506048104,0.082650658963711932,0.083804657880483913],"mode":"none","stackgroup":"one","type":"scatter","name":"custom_offer","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30],"y":[0.046361166275500375,0.071834627189022476,0.086660678822891399,0.096354666907383202,0.10257474273334458,0.11128181982307196,0.11798194619967425,0.12479310344827509,0.13049647950893586,0.13638779563097955,0.14267683697418232,0.14682460732984218,0.15172495035204836,0.15717277486910922,0.16132884997291858,0.16692959017873188,0.17200649936811624,0.17684916049828414,0.18108738039357214,0.18422738761509225,0.18907302762231376,0.19374462899440259,0.19826322440873731,0.20198691099476368,0.2063710055966774,0.21046768369741758,0.21484112655713958,0.21920635493771368,0.22273253294818487,0.22743076367575304,0.2313996208701925],"mode":"none","stackgroup":"one","type":"scatter","name":"other","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```

### level 5 (N)

Посчитайте по каждой платформе динамику ARPU 0, 1, 7 и 30 дней (сколько в среднем заплатили пользователи когорты в день инсталла, за 0 и 1 дни жизни в приложении, за первые 7 дней жизни, за первые 30 дней жизни в приложении). 
На графике на оси OX должна быть дата инсталла, на оси OY -- значение ARPU, с разбивкой, по какому количеству дней от инсталла мы это считаем

Делать аналогично динамике ретеншена, я показывал на занятии про ретеншен как раз близкое решение.



``` r
arpu_dyn <- merge(
  payments,
  installs[, list(user_pseudo_id, platform, dt)],
  by = c('user_pseudo_id', 'platform'), all.x = TRUE
)

# удаляю пользователей, которые пришли раньше июня
arpu_dyn <- conversion_dyn[!is.na(dt)]
arpu_dyn[, lifetime := pay_dt - dt]

arpu_dyn_stat <- arpu_dyn[, list(gross = sum(gross)), by = list(dt, lifetime)]


# присоединяю рыбу
arpu_dyn_stat <- merge(arpu_fish, arpu_dyn_stat, by = c('dt', 'lifetime'), all.x = TRUE)

# считаю, сколько всего было пользователей в когорте
# conversion_stat[, total_users := installs[dt < '2022-07-01', uniqueN(user_pseudo_id)]]
arpu_dyn_stat <- merge(
  installs[, list(total_users = uniqueN(user_pseudo_id)), by = list(dt)],
  arpu_dyn_stat,
  by = c('dt'), all.x = TRUE
)

# сортирую и считаю накопительный гросс
arpu_dyn_stat <- arpu_dyn_stat[order(dt, lifetime)]
arpu_dyn_stat[is.na(gross), gross := 0]
arpu_dyn_stat[, gross_cum := cumsum(gross), by = list(dt)]

# считаю накопительную конверсию в платящих
arpu_dyn_stat[, cum_ARPU := gross_cum / total_users]

# рисую
plot_ly(
  arpu_dyn_stat[lifetime %in% c(0, 3, 7, 30)], 
  x = ~dt, y = ~cum_ARPU, 
  type = 'scatter', mode='lines', color = ~as.character(lifetime)
) %>%
  layout(
    title = 'Динамика накопительного ARPU дневных когорт',
    yaxis = list(rangemode = 'tozero')
  ) %>%
  config(displayModeBar = FALSE)    
```

```{=html}
<div class="plotly html-widget html-fill-item" id="htmlwidget-14d9d81704447d7d80c3" style="width:672px;height:480px;"></div>
<script type="application/json" data-for="htmlwidget-14d9d81704447d7d80c3">{"x":{"visdat":{"8dfc1760f3ba":["function () ","plotlyVisDat"]},"cur_data":"8dfc1760f3ba","attrs":{"8dfc1760f3ba":{"x":{},"y":{},"mode":"lines","color":{},"alpha_stroke":1,"sizes":[10,100],"spans":[1,20],"type":"scatter"}},"layout":{"margin":{"b":40,"l":60,"t":25,"r":10},"title":"Динамика накопительного ARPU дневных когорт","yaxis":{"domain":[0,1],"automargin":true,"rangemode":"tozero","title":"cum_ARPU"},"xaxis":{"domain":[0,1],"automargin":true,"title":"dt"},"hovermode":"closest","showlegend":true},"source":"A","config":{"modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false,"displayModeBar":false},"data":[{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.10835122174012339,0.18054822335025392,0.13522655122655131,0.15423697975892667,0.15859189025620349,0.11429450649646693,0.094605399792315761,0.11239935956084181,0.05874528539099827,0.058660514541387036,0.079080595603876216,0.086806833114323328,0.078793436293436339,0.1459433962264152,0.036645260724377078,0.21614568258562486,0.051961952784781121,0.081799856011519123,0.068761980830670977,0.072243885753377854,0.055847531673219784,0.14473266643670235,0.12480112636395639,0.06372492836676219,0.056254734848484825,0.046447893569844766,0.033369928400954658,0.063355350066050212,0.023719376391982183,0.097496561210453928,0.054974182444061971,0.017452229299363058,0.41053543307086621,0.10164203612479475,0.081880000000000008,0.030509164969450102,0.13789883268482492,0.18830223880597011,0.30980496453900719,0.11747899159663866,0.12910839160839163,0.078016032064128271,0.080605381165919268,0,0.070462287104622878,0.076053811659192824,0.1161995249406176,0.091445783132530128,0.08894977168949772,0.2450137741046832,0.058126582278481012,0.070570776255707776,0.023672985781990522,0.022035398230088498,0.10644670050761422,0.043936430317848406,0.16474226804123712,0.053266666666666664,0.036189516129032262,0.054883720930232555,0.02244943820224719],"mode":"lines","type":"scatter","name":"0","marker":{"color":"rgba(102,194,165,1)","line":{"color":"rgba(102,194,165,1)"}},"textfont":{"color":"rgba(102,194,165,1)"},"error_y":{"color":"rgba(102,194,165,1)"},"error_x":{"color":"rgba(102,194,165,1)"},"line":{"color":"rgba(102,194,165,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.21685544644896107,0.37571319796954339,0.29571717171717188,0.82965203547873589,0.3189348396207386,0.25403692728516081,0.20507528556593985,0.26523101555352258,0.20662056826753847,0.19016219239373602,0.24195225714961016,0.26159001314060459,0.27380308880308896,0.32766576819407028,0.17872591831492426,0.54990834539315037,0.16593399037359616,0.20802195824334066,0.15504952076677322,0.21578074226098867,0.098152031454783795,0.32313556398758198,0.25417458641323482,0.17859598853868197,0.22456912878787871,0.15139689578713966,0.10485918854415274,0.1801651254953765,0.12377876763177433,0.26368638239339753,0.16493975903614461,0.13675159235668788,0.66672440944881894,0.34272577996715931,0.19374,0.23177189409368637,0.4542217898832685,0.60718283582089538,0.32921985815602844,0.20305882352941176,0.22164335664335663,0.2882565130260521,0.09618834080717488,0.047515527950310554,0.16272506082725061,0.11186098654708521,0.32261282660332541,0.24062650602409638,0.10488584474885844,0.50931129476584025,0.16425316455696201,0.40340182648401823,0.047251184834123224,0.092721238938053091,0.1419289340101523,0.10009779951100244,0.22394329896907217,0.099844444444444444,0.12280241935483872,0.26602536997885828,0.02244943820224719],"mode":"lines","type":"scatter","name":"3","marker":{"color":"rgba(252,141,98,1)","line":{"color":"rgba(252,141,98,1)"}},"textfont":{"color":"rgba(252,141,98,1)"},"error_y":{"color":"rgba(252,141,98,1)"},"error_x":{"color":"rgba(252,141,98,1)"},"line":{"color":"rgba(252,141,98,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.90298698332952743,0.7691751269035535,0.74028571428571444,2.1761041619285884,0.85372806132741597,0.9503601550034193,0.76152647975077892,0.78114135407136343,0.92498114156399314,0.74943232662192405,0.81399669108957717,0.92553438458169091,0.7469715250965252,0.82788948787062,0.53000000000000003,1.1336927158707193,0.79088012835205135,0.58314794816414695,0.62084025559105427,0.58085684966649576,0.29906509392747926,1.4907761296998967,0.83222104892643445,0.5543430208759722,0.75694602272727274,0.27805321507760528,0.43189976133651553,0.28709379128137386,0.81725315515961394,1.3834800550206328,4.2512736660929429,0.39925159235668789,1.046015748031496,0.95123152709359615,0.40742,1.0142362525458248,1.3180544747081713,1.1173880597014925,0.68180851063829795,0.31216806722689078,0.60909090909090913,0.77270541082164323,0.49475336322869956,0.22134575569358178,0.27201946472019461,0.26865470852017936,0.62144893111638955,0.36812048192771085,0.18013698630136987,0.71280991735537191,0.49050632911392406,0.75431506849315078,0.059075829383886252,0.12143805309734514,0.17738578680203046,0.12452322738386308,0.22394329896907217,0.099844444444444444,0.12280241935483872,0.26602536997885828,0.02244943820224719],"mode":"lines","type":"scatter","name":"30","marker":{"color":"rgba(141,160,203,1)","line":{"color":"rgba(141,160,203,1)"}},"textfont":{"color":"rgba(141,160,203,1)"},"error_y":{"color":"rgba(141,160,203,1)"},"error_x":{"color":"rgba(141,160,203,1)"},"line":{"color":"rgba(141,160,203,1)"},"xaxis":"x","yaxis":"y","frame":null},{"x":["2022-06-01","2022-06-02","2022-06-03","2022-06-04","2022-06-05","2022-06-06","2022-06-07","2022-06-08","2022-06-09","2022-06-10","2022-06-11","2022-06-12","2022-06-13","2022-06-14","2022-06-15","2022-06-16","2022-06-17","2022-06-18","2022-06-19","2022-06-20","2022-06-21","2022-06-22","2022-06-23","2022-06-24","2022-06-25","2022-06-26","2022-06-27","2022-06-28","2022-06-29","2022-06-30","2022-07-01","2022-07-02","2022-07-03","2022-07-04","2022-07-05","2022-07-06","2022-07-07","2022-07-08","2022-07-09","2022-07-10","2022-07-11","2022-07-12","2022-07-13","2022-07-14","2022-07-15","2022-07-16","2022-07-17","2022-07-18","2022-07-19","2022-07-20","2022-07-21","2022-07-22","2022-07-23","2022-07-24","2022-07-25","2022-07-26","2022-07-27","2022-07-28","2022-07-29","2022-07-30","2022-07-31"],"y":[0.26655857501712732,0.49644416243654838,0.37066089466089475,1.235069365476462,0.48194875933024034,0.37786186459995452,0.28935358255451715,0.40320905763952442,0.33926074930852412,0.36845917225950786,0.37940203261640293,0.44099430573806414,0.35189189189189202,0.4291886792452832,0.23105574107372212,0.69377713458755463,0.25320421728168691,0.28588552915766752,0.24024440894568694,0.26756114246622215,0.144866754041066,0.54197654363573655,0.36737768391411474,0.28613999181334426,0.38631628787878786,0.19567184035476715,0.21021002386634843,0.23303830911492737,0.3545211581291759,0.51929848693259972,0.49158347676419967,0.1830095541401274,0.80195275590551196,0.71018062397372739,0.30957999999999997,0.43896130346232182,0.60953307392996114,0.66479477611940285,0.41241134751773056,0.24332773109243697,0.41715034965034969,0.50446893787575153,0.15887892376681614,0.078467908902691508,0.18703163017031632,0.14993273542600899,0.37945368171021376,0.24542168674698797,0.15050228310502284,0.56429752066115701,0.43739240506329119,0.67205479452054795,0.059075829383886252,0.12143805309734514,0.17738578680203046,0.12452322738386308,0.22394329896907217,0.099844444444444444,0.12280241935483872,0.26602536997885828,0.02244943820224719],"mode":"lines","type":"scatter","name":"7","marker":{"color":"rgba(231,138,195,1)","line":{"color":"rgba(231,138,195,1)"}},"textfont":{"color":"rgba(231,138,195,1)"},"error_y":{"color":"rgba(231,138,195,1)"},"error_x":{"color":"rgba(231,138,195,1)"},"line":{"color":"rgba(231,138,195,1)"},"xaxis":"x","yaxis":"y","frame":null}],"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.20000000000000001,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>
```


## Метрики монетизации

Для июньской когорты, с разбивкой по платформе посчитать:

- количество пользователей
- количество платящих пользователей
- конверсия
- гросс
- арпу
- арппу
- средний размер платежа (гросс / количество платежей)
- среднее количество платежей на пользователя (количество платежей / количество платящих)

Все в окне 30 дней от инсталла.


``` r
installs_june <- installs[dt < '2022-07-01']
installs_june_stat <- installs_june[, list(total_users = uniqueN(user_pseudo_id)), by = platform]


payments_june <- merge(
    installs_june[, list(user_pseudo_id, dt)],
    payments,
    by = 'user_pseudo_id', all = FALSE
)
payments_june[, lifetime := pay_dt - dt]
payments_june <- payments_june[lifetime <= 30]

payments_june_stat <- payments_june[, list(
    payers_30 = uniqueN(user_pseudo_id),
    gross_30 = sum(gross),
    n_transactions_30 = length(ts)
  ), 
  by = platform]

users_june_stat <- merge(
  installs_june_stat,
  payments_june_stat,
  by = 'platform', all.x = TRUE
)


users_june_stat[, gross_30 := round(gross_30)]
users_june_stat[, Conversion_30 := paste0(round(payers_30 / total_users * 100, 1), '%')]
users_june_stat[, ARPU_30 := round(gross_30 / total_users, 3)]
users_june_stat[, ARPPU_30 := round(gross_30 / payers_30, 3)]
users_june_stat[, Av.Check_30 := round(gross_30 / n_transactions_30, 1)]
users_june_stat[, Av.Purchases_30 := round(n_transactions_30 / payers_30, 1)]

users_june_stat
```

```
## Key: <platform>
##    platform total_users payers_30 gross_30 n_transactions_30 Conversion_30
##      <char>       <int>     <int>    <num>             <int>        <char>
## 1:  ANDROID       77770      1143    25452              3376          1.5%
## 2:      IOS       33010      1458    65402              7346          4.4%
##    ARPU_30 ARPPU_30 Av.Check_30 Av.Purchases_30
##      <num>    <num>       <num>           <num>
## 1:   0.327   22.268         7.5               3
## 2:   1.981   44.857         8.9               5
```



## ARPDAU

Некогортная метрика -- сколько в среднем приносит каждый зашедший в этот день пользователь. Обычно используется на дашбордах для мониторинга, какие сегменты пользователей как платят.

ARPDAU = revenue / DAU

## Paying share

Еще одна некогортная метрика -- какая доля платящих среди зашедших в этот день. Также используется для мониторинга. 

Paying share = Payers / DAU

## Воронка платежей

Доля пользователей, которые сделали второй, третий и т.д. платеж. Нужна для понимания, совершают ли пользователи повторные платежи. Дальше начинаются вопросы и интерпретации -- почему не сделал второй платеж, и т. д.

Алгоритм расчета:
- берем таблицу платежей пользователя
- сортируем по времени платежа
- создаем новую колонку-счетчик (1, 2, 3) платежей для каждого пользователя
- считаем, сколько пользователей сделало каждый номер платежа (т.е группируем по этому счетчику)
- делим количество пользователей на сколько всего было пользователей, сделавших первый платеж (т.е. на значение из первой колонки)
- рисуем барчартами

 - опционально: лучше ограничить это все на лайфтайм (например, на 7 дней) и на количество платежей (например, 10, чтобы баров было не сильно много и график был читаемым)


Как создать колонку-счетчик:


``` r
# в R
my_dt[, counter := 1:.N, by = uid]

# в Python
my_dt['counter'] = my_dt.groupby('uid').cumcount() + 1
```



## Домашнее задание


### level 1 (IATYTD)

Внимательно разберите решения заданий (материалы конспекта).

### level 2 (HNTR)

Рассчитайте табличку с метриками монетизации для июньской когорты. Сделайте разбивку по платформам. Попробуйте проинтерпретировать результаты.

### level 3 (HMP)

Рассчитайте табличку с метриками монетизации для июньской и июльской когорт (должно быть две строки в табличке, отдельно на каждую когорту). Выберите правильный период лайфтайма. Попробуйте проинтерпретировать результаты.

### level 4 (UV)

Постройте воронку платежей для июньской когорты. Сделайте разбивку по платформам. Попробуйте проинтерпретировать результаты.

### level 5 (N)

Постройте графики ARPDAU и Paying Share. Для этого вам понадобится табличка логинов (https://gitlab.com/hse_mar/mar211f/-/raw/main/data/dau.csv).

Сделайте эти метрики в разбивке по тому, как давно пользователи пришли в приложение:

-   группа 1: 0 дней с инсталла
-   группа 2: 1-7 дней с момента инсталла
-   группа 3: 8-28 дней с инсталла
-   группа 4: более 28 дней с инсталла



